<!DOCTYPE html>
<meta charset="utf-8">
<style>
.box{
  border:2px solid;
  background-color:rgba(0,0,0,0.4);
  font-weight: bold;
  font-size: 15px;
}

#optCounterCall{
  visibility: hidden;
  position: absolute;
  left:925px;
  top:400px;
}
#optCounterPut{
  visibility: hidden;
  position: absolute;
  left:925px;
  top:400px;
}

#verticalline{
  position: absolute;
  color:grey;
  top: 70px;
  left: 900px;
  height: 700px;
  border-left: solid;
}

#horizontalline {
  position: absolute;
  color:grey;
  left:5px;
  top: 485px;
  width: 895px;
  border-top: solid;
}

#help_1 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
#help_2 {
  position: absolute;
  left:400px;
  top:80px;
  visibility:hidden;
}
#help_3{
  position: absolute;
  left:100px;
  top:300px;
  visibility:hidden;
}
#help_4 {
  position: absolute;
  left:100px;
  top:600px;
  visibility:hidden;
}

#help_5 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
#help_6 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
#help_7 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
#help_8 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
#help_9 {
  position: absolute;
  left:100px;
  top:80px;
  visibility:hidden;
}
.bar {
  fill: steelblue;
}

.bar:hover{
  fill:brown;
}

.bar2 {
  fill: steelblue;
}

.bar2:hover{
  fill:brown;
}

div{
  display: block;
}

body {
  font: 10px sans-serif;
  background-color: #f9f9f9;
}
.city {
  clip-path: url(#clip);
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

.legend {
  padding: 5px;
  font: 10px sans-serif;
  background: yellow;
  box-shadow: 2px 2px 1px #888;
}

#investOppert {
    position: absolute; 
    top: 50px;
    left: 900px;
    clear:right;
    display: inline-block;
    word-wrap: break-word;
    width:250px;
    height:200px;
    padding-left:10px;
    padding-right:10px;
    margin-right: 50px;
    margin-left:50px;
    margin-top:30px;
    text-align: center;
}

#slider {
  visibility:hidden;
  position: absolute;
  top: 250px;
  left: 925px;
}

#strats {
  visibility:hidden;
  position: absolute;
  top: 280px;
  left: 925px;
}

#navbar {
  width:100%;
  height:60px;
  /*background-color: #802c59;*/
  /*background-color: #1c94c6;    #CCC */
  background-color:maroon;
  border-bottom: 2px solid grey;
}

#headContainer {
  width:900px;
  margin-right: auto;
  margin-left: auto;
}

#name {
  font-size: 16px;
  font-weight: 250;
  color: white;
  padding:3px;
}


#nav li {
  display: inline;
  list-style-type: none;
  padding-right: 40px;
}


</style>
<script src="http://d3js.org/d3.v3.js"></script>
<body>
  <div id="navbar">
    <div id="headContainer">
      <div id="name">
        <ul id="nav">
          <li>Visualising Investment Returns</li>
          <li>Visualize</li>
          <li> <a class="button" onclick="about()">About</a></li>
          <li> <a class="button" onclick="tour()">Tour</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="investOppert">
      <h1 id="stock">No stock selected</h1>
      <h2 id="money"></h2>
      <h3 id="stockPrice"></h3>
      <button onclick="results()">Invest!</button>
  </div>
  <form id="optCounterPut">
    <input id = "numPut" type="number" name="quantity" min="-10" max="10" value="0" onchange="optGraphPut()">
    <span id="optTypePut">Hello</span>
  </form>

  <form id="optCounterCall">
    <input id = "numCall" type="number" name="quantity" min="-10" max="10" value="0" onchange="optGraphCall()">
    <span id="optTypeCall">Hello</span>
  </form>

<script>
// Change global var names
// Change domain and line names
// Change City name to stocks
//

// Nu: PayoffData array met 8 elementen in elke element steeds een waarde pushen
// beter: PayoffData array met 8 elementen met daarin 1 + #puts + # optie elementen?
// var {68: {-2, price[k]}}, 60:{4,price[k]}
//     onchange="optGraph()"

// First one
var optionsJSON;

// Some global variables I'm using
var k = 0,
    dateToMaturity = 20,
    thisAmount = [0,0,0,0,0,0,0,0],
    shareIndex = [0,0,0,0,0,0,0,0],                                     
    thisAmountOpt = [0,0,0,0,0,0,0,0],
    newPrice = [0,0,0,0,0,0,0,0],
    checked_boxes = [-1,-1,-1,-1,-1,-1,-1,-1],
    thisPrice = [],
    cities = 0,
    totalInvestment = 40000,
    strUser = "",
    strike1,
    price1,
    strike2,
    price2
    allData = [{},{},{},{},{},{},{},{}],
    optionInfo = 0;

// Margins   
var margin = {top: 20, right: 525, bottom: 400, left: 130},
    marginxBrush = {top: 330, right: 525, bottom: 320, left: 130},
    marginPayoff = {top: 450, right: 525, bottom: 55, left: 50},
    marginyBrush = {top: 20, right: 1185, bottom: 400, left: 30},
    marginbar = {top:380, right: 20, bottom: 120, left:950};

// Width and heights
//margins right + 135
var width = 1280 - margin.left - margin.right,
    width3 = 1280 - marginPayoff.left - marginPayoff.right,
    width4 = 1280 - marginyBrush.left - marginyBrush.right,
    widthbar = 1280 - marginbar.left - marginbar.right,

    height = 700 - margin.top - margin.bottom,
    height2 = 700 - marginxBrush.top - marginxBrush.bottom,
    height3 = 700 - marginPayoff.top - marginPayoff.bottom,
    height4 = 700 - marginyBrush.top - marginyBrush.bottom;
    heightbar = (700 - marginbar.top - marginbar.bottom)/2;

// Date and money elements
var parseDate = d3.time.format("%d-%m-%Y").parse,
    bisectDate = d3.bisector(function(d) { return d.date; }).left,
    bisectNum = d3.bisector(function(d) {return d.price;}).left,
    formatValue = d3.format(",.2f"),
    formatCurrency = function(d) { return "$" + formatValue(d); };

// Colors
var color = d3.scale.category10();

// Scaling
var x = d3.time.scale().range([0, width]),
    x2 = d3.time.scale().range([0, width]),
    x3 = d3.scale.linear().range([0,width3]),
    x4 = d3.time.scale().range([0, width4]),
    //xbar = d3.scale.linear().range([widthbar, 0]),
    xbar = d3.scale.linear().range([0, widthbar]),

    y = d3.scale.linear().range([height, 0]),
    y2 = d3.scale.linear().range([height2, 0]),
    y3 = d3.scale.linear().range([height3, 0]),
    y4 = d3.scale.linear().range([height4, 0]),
    ybar1 = d3.scale.ordinal().rangeRoundBands([0, heightbar], .2);
    ybar2 = d3.scale.ordinal().rangeRoundBands([0, heightbar], .2);

// Axes
var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom"),
    xAxis3 = d3.svg.axis().scale(x3).orient("bottom"),
    xAxis4 = d3.svg.axis().scale(x4).orient("bottom"),
    xAxisbar = d3.svg.axis().scale(xbar).orient("bottom").ticks(8),

    yAxis = d3.svg.axis().scale(y).orient("left"),
    yAxis3 = d3.svg.axis().scale(y3).orient("left"),
    yAxis4 = d3.svg.axis().scale(y4).orient("left");
    yAxisbar1 = d3.svg.axis().scale(ybar1).orient("left")
    yAxisbar2 = d3.svg.axis().scale(ybar2).orient("left")

// Horizontal and vertical brushes
var brushx = d3.svg.brush()
    .x(x2)
    .on("brush", brushedx);

var brushy = d3.svg.brush()
    .y(y4)
    .on("brush", brushedy);

// 4 Lines I'm using
var line1 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.price); });

var line2 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x2(d.date); })
    .y(function(d) { return y2(d.price); });

var line3 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x3(d.key); })
    .y(function(d) { return y3(d.price); });

var line4 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x4(d.date); })
    .y(function(d) { return y4(d.price); });

// SLIDER



// Appending the SVG element
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

// Clip path for when using the brush
svg.append("defs").append("clipPath")
    .attr("id", "clip")
    .append("rect")
    .attr("width", width)
    .attr("height", height);

// Main element where the stock charts are in
var main = svg.append("g")
    .attr("class", "main")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Two brush elements
var xBrush = svg.append("g")
    .attr("class", "xBrush")
    .attr("transform", "translate(" + marginxBrush.left + "," + marginxBrush.top + ")");

var yBrush = svg.append("g")
    .attr("class", "yBrush")
    .attr("transform", "translate(" + marginyBrush.left + "," + marginyBrush.top + ")");

// Payoff element
var payoff = svg.append("g")
    .attr("class", "payoff")
    .attr("transform", "translate(" + marginPayoff.left + "," + marginPayoff.top + ")");

// Tooltip main graph
var toolTip1 = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .style("display", "none");

// Tooltip payoff graph
var toolTip2 = svg.append("g")
    .attr("transform","translate(" + marginPayoff.left + "," + marginPayoff.top + ")")

// where the small charts are put in
var chart = svg.append("g")
    .attr("class", "chart")
    .attr("transform", "translate(" + marginbar.left +"," +marginbar.top +")");

// Bar chart
var chart1 = svg.append("g")
    .attr("class", "chart1")
    .attr("transform", "translate(" + marginbar.left +"," +marginbar.top +")");
bar2 = +marginbar.top +heightbar+40 
var chart2 = svg.append("g")
    .attr("class", "chart2")
    .attr("transform", "translate(" + marginbar.left +"," +bar2 +")");

document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)

// Load option data (NOT USING YET)
d3.json("optionsDataBetterLess.json", function(data) {optionsJSON = data;})

// Main data
d3.json("AllData.json", function(error, data) {
  console.log(optionsJSON)
  // Color domain are all names in the data except the date
  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  // Parse the date
  data.forEach(function(d) {
    d.date = parseDate(d.date);
     });

  // Sort the date
  data.sort(function(a, b) {
    return a.date - b.date;});

  // Assign the cities a color and map the values 
  cities = color.domain().map(function(name) {
      return {
          name: name,
          values: data.map(function(d) {
              return {date: d.date, price: +d[name]};
          })
      };
  });

  // Last known price for all stocks in one array
  for (i = 0; i < cities.length; i++) {
    thisPrice.push(cities[i].values[(cities[i].values).length-1].price)
  }

// ------------------------------------------------------------------
// Domains
// ------------------------------------------------------------------
  // x,x2,x4 and y,y2,y4 domains
  x.domain(d3.extent(data, function(d) { return d.date; }));

  y.domain([
    0,
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.price; }); })
  ]);

  x2.domain(x.domain());
  y2.domain(y.domain());
  x4.domain(x.domain());
  y4.domain(y.domain());

// ------------------------------------------------------------------
// Main graph
// ------------------------------------------------------------------
  // Place the x axis
  main.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  // Place the y axis
  main.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("price ($)");

  // Place all the stocks
  var city = main.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("id", function(d,i) {;return d.name})
      .attr("d", function(d) { return line1(d.values); })
      .style("stroke", function(d) { return color(d.name); })
      .style("fill", "none")
      .style("stroke-width", "1.5px");

// ------------------------------------------------------------------
// Legend
// ------------------------------------------------------------------

  // Spacing between legend
  space = height/cities.length

  // Add the main legend class
  var legend = svg.append("g")
    .attr("class", "legend") 
      
  // Add all the names with appropriate spacing  
  legend.selectAll('text')
    .data(cities)
    .enter()
    .append("text")
    .attr("id", function(d,i) {return d.name})
    .attr("x", width+ margin.left +10)
    .attr("y", function(d, i){ return (i+0.5) * space + margin.top;})
    .style("fill", function(d) {return color(d.name)})
    .text(function(d) { return d.name;})
    .on("click", function(d, i){

          // Set variable to active or inactive and denote the current stock index
          var active  = d.active ? false : true;
          d.active = active
          k = i
          // Call functions that depent on activation of stock
          payoffResult()
          payoffLegendName()
          optionbars()
          editSlider()
          // uncheck all boxes
          boxes = document.getElementsByName("strategy")
          for (i=0; i<boxes.length; i++){
              boxes[i].checked = false
          }

          document.getElementById("strats").style.visibility = "visible"
          // Edit the information on thfe page
          document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)
          document.getElementById("stock").innerHTML = "Investing in " +cities[k].name;
          document.getElementById("stockPrice").innerHTML = "Current price  " +thisPrice[k];
          if (strUser == "shares") {
              document.getElementById("amount").value = thisAmount[k]
          }
          // When active
          if (active == true) {
              d3.select("#navbar")
                .transition().duration(1000)
                .style("background-color",color(d.name))
              // Values for the line, and change the line
              onOpacity = 5;
              offOpacity = 2;
              legend.select("#"+d.name)
                    .transition().duration(1000)
                    .style("font-size","15px")
                    .style("font-weight","bold")
              d3.select("#"+d.name.replace(/\s+/g, ''))
                  .transition().duration(1000) 
                  .style("stroke-width", onOpacity)
                  .style("opacity", 1);
              // Put all stocks except this one to false
              for (j = 0; j < cities.length; j++) {
                  if (j != i) {
                      d3.select("#"+cities[j].name)
                        .transition().duration(1000) 
                        .style("stroke-width", offOpacity)
                        .style("opacity", 0.5);

                      legend.select("#"+cities[j].name)
                        .transition().duration(1000)
                        .style("font-size","10px")
                        .style("font-weight","normal")
                        cities[j].active = false;
                  };
              };
            // Change all the lines to normal if none are active
          } else {
              d3.select("#navbar")
                .transition().duration(1000)
                .style("background-color","maroon")

              for (j = 0; j < cities.length; j++) {
                  d3.select("#"+cities[j].name)
                    .transition().duration(1000) 
                    .style("stroke-width", 2)
                    .style("opacity", 1);

                  legend.select("#"+cities[j].name)
                        .transition().duration(1000)
                        .style("font-size","10px")
                        .style("font-weight","normal")
              }
          }
    });
// ------------------------------------------------------------------
// Brush X Section
// ------------------------------------------------------------------
  
  // Place the x axis for the horizontal brush
  xBrush.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);  

  // Place all the stocks
  var city2 = xBrush.selectAll(".city2")
      .data(cities)
    .enter().append("g")
      .attr("class", "city2")

  city2.append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line2(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  xBrush.append("g")
      .attr("class", "x brush")
      .call(brushx)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height2 + 7);  

// ------------------------------------------------------------------
// Brush Y Section
// ------------------------------------------------------------------
  
  // Place the y axis for the vertical brush
  yBrush.append("g")
      .attr("class", "y axis")
      .call(yAxis4)
    .append("text")
      .attr("transform", "rotate(-90)")

  // Place all the stocks
  var city3 = yBrush.selectAll(".city3")
      .data(cities)
    .enter().append("g")
      .attr("class", "city3")

  city3.append("path")
      .attr("class", "line")
      .attr("d", function(d) {return line4(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  yBrush.append("g")
      .attr("class", "y brush")
      .call(brushy)
    .selectAll("rect")
      .attr("x", 0)
      .attr("width", width4)

// ------------------------------------------------------------------
// Tooltip Main Graph
// ------------------------------------------------------------------

  // Add a circle for the tooltip
  toolTip1.append("circle")                                 
      .attr("class", "y")                                
      .style("fill", "none")                             
      .style("stroke", "black")                           
      .attr("r", 4);

  // Add the text for the tooltip
  toolTip1.append("text")
      .attr("class", "y2")
      .attr("dx", -2)
      .attr("dy", -10)
      .style("font-size", "15px");

  // Rectangle for when the tooltip shows if the mouse is on it
  main.append("rect")                                     
      .attr("width", width)                              
      .attr("height", height+margin.bottom/3)                            
      .style("fill", "none")                             
      .style("pointer-events", "all")                    
      .on("mouseover", function() { toolTip1.style("display", null); })
      .on("mouseout", function() { toolTip1.style("display", "none"); })
      .on("mousemove", mousemove); 

  // Function for when the mouse moves on the rectangle
  function mousemove() {
    // Get the date, its index, values left and right of the date and the intrapolation
    var mouseDate = x.invert(d3.mouse(this)[0]),              
        i = bisectDate(cities[k].values, mouseDate, 1),                   
        d0 = cities[k].values[i - 1],                              
        d1 = cities[k].values[i],                            
        d = mouseDate - d0.date > d1.date - mouseDate ? d1 : d0;
    
    // Move the circle on the graph where the mouse is
    toolTip1.select("circle.y")                           
        .attr("transform",                             
              "translate(" + x(d.date) + "," +         
                             y(d.price) + ")");

    // Place the price above of the circle
    toolTip1.select("text.y2")
        .attr("transform",
              "translate(" + x(d.date) + "," +
                             y(d.price) + ")")
        .text(formatCurrency(d.price));   
    }

// ------------------------------------------------------------------
// Tooltip Payoff Graph
// ------------------------------------------------------------------

  toolTip2.append("circle")                                 
      .attr("class", "y")                                
      .style("fill", "none")                             
      .style("stroke", "black")                           
      .attr("r", 4);

  // Add the text for the tooltip
  toolTip2.append("text")
      .attr("class", "y2")
      .attr("dx", -2)
      .attr("dy", -30)
      .style("font-size", "15px");

  toolTip2.append("text")
      .attr("class", "y3")
      .attr("dx", -2)
      .attr("dy", -10)
      .style("font-size", "15px");

  // Rectangle for when the tooltip shows if the mouse is on it
  payoff.append("rect")                                     
      .attr("width", width3)                              
      .attr("height", height3)                            
      .style("fill", "none")                             
      .style("pointer-events", "all")                    
      .on("mouseover", function() { toolTip2.style("display", null); })
      .on("mouseout", function() { toolTip2.style("display", "none"); })
      .on("mousemove", mousemovepayoff); 

  // Function for when the mouse moves on the rectangle
  function mousemovepayoff() {
    // Get the date, its index, values left and right of the date and the intrapolation
    var mouseNum = x3.invert(d3.mouse(this)[0]);
    i2 = Math.round(mouseNum+40-thisPrice[k])
    //console.log(payoffData[k][payoffData[k].length-1][i2].price)
    if (payoffData[k].length !== 0) {
        if (payoffData[k].length === 1) {
          d = payoffData[k][payoffData[k].length-1][i2]}
        else { d = profit[i2]}
        toolTip2.select("circle.y")                           
            .attr("transform",                             
                  "translate(" + x3(d.key) + "," +         
                                 y3(d.price) + ")");

            +"\n" +"strke:"+formatCurrency(d.key)
        // Place the price above of the circle
        toolTip2.select("text.y2")
            .attr("transform",
                  "translate(" + x3(d.key) + "," +
                                 y3(d.price) + ")")
            .text("Profit: "+formatCurrency(d.price)); 

        toolTip2.select("text.y3")
            .attr("transform",
                  "translate(" + x3(d.key) + "," +
                                 y3(d.price) + ")")
            .text("Price: "+formatCurrency(Math.round(d.key)));
      } else {toolTip2.style("display", "none");}
    }

// ------------------------------------------------------------------
// Payoff graph
// ------------------------------------------------------------------ 

  // Initial empty graph
  x3.domain([0,0]);
  y3.domain([0,0]);
  payoffData = [[],[],[],[],[],[],[],[]]

  // Place the x axis
  payoff.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height3/2 + ")")
      .call(xAxis3)
      .append("text")
      .attr("y", 35)
      .attr("x", width3-30)
      .text("price ($)");

  // place the y axis
  payoff.append("g")
      .attr("class", "y axis")
      .call(yAxis3)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("profit ($)");
  

  // Graph after update (Not really that great atm) 
  window.payoffResult = function() {
    payoffData[k] = []
    // Remove all the old graphs
    payoff.selectAll(".city3").remove()

    //
    optionAmount = 0
    for (m=0; m<Object.keys(allData[k]).length; m++){
      optionAmount += Math.abs(allData[k][Object.keys(allData[k])[m]][0]);
      if (allData[k][Object.keys(allData[k])[m]][0] === "0") {
        delete allData[k][Object.keys(allData[k])[m]];
      }
    }
    console.log(allData[k])
    // Create lines if there are line elements
    if (optionAmount !== 0) {

        // Compute all the line information
        for (i = 0; i < Object.keys(allData[k]).length; i++ ){
            lineInfo =[]
            for (j = thisPrice[k]-40; j <= thisPrice[k] +40; j++){
                // if it does contain c then its a call
                if (Object.keys(allData[k])[i].indexOf("c") !== -1 ){
                    // replace the c
                    thisStrike = Object.keys(allData[k])[i].replace("c","")
                    lineInfo.push({
                        key: j,
                        price: allData[k][Object.keys(allData[k])[i]][0]
                                *(100 * d3.max([j - thisStrike,0]) 
                                - allData[k][Object.keys(allData[k])[i]][1])
                    })
                // if it does contain p then its a put
                } else if (Object.keys(allData[k])[i].indexOf("p") !== -1) {
                    thisStrike = Object.keys(allData[k])[i].replace("p","")
                    lineInfo.push({
                        key: j,
                        price: allData[k][Object.keys(allData[k])[i]][0]
                                *(100 * d3.max([thisStrike - j,0]) 
                                - allData[k][Object.keys(allData[k])[i]][1])
                    })
                // otherwise they are shares
                } else {
                    lineInfo.push({
                        key: j,
                        price: (j-thisPrice[k]) * allData[k][Object.keys(allData[k])[i]]
                    })
                       
                }
            }
            payoffData[k].push(lineInfo)
        }

        // No profit line if there is only 1 line
        profit = []
        for (j = 0; j < 81; j++) {
            profitKey = 0
            for (i = 0; i < payoffData[k].length; i++) {
                profitKey += payoffData[k][i][j].price
            }
            profit.push({
              key: payoffData[k][0][j].key,
              price: profitKey
            })
        }
        if (payoffData[k].length >=2) {payoffData[k].push(profit)}
      // Find the highest and lowest values
        yMax = 0;
        yMin = 0;
        dom = [];
        // Done by looping over all the elements and finding the highest and lowest
        for (i = 0; i<payoffData[k].length; i++) {
            for (j = 0; j < payoffData[k][i].length; j++) {
                if (payoffData[k][i][j].price < yMin) {yMin = payoffData[k][i][j].price}
                else if (payoffData[k][i][j].price > yMax) {yMax=payoffData[k][i][j].price}
            } 
        };
        dom = [yMin, yMax]

        // Set the domains
        x3.domain(d3.extent(payoffData[k][0], function(d) { return d.key; }));
        y3.domain(dom);

        // Set the intersection point to 1/2 of the graph if there are no lines
        if (payoffData[k].length == 0){
            intersection = 0.5
        } else{
            intersection =  Math.abs(dom[1])/(Math.abs(dom[1])+Math.abs(dom[0]));
        } 

        // Plot a max of 5 graphs
        if (payoffData[k].length > 5) {
            len = payoffData[k].length
            dataPlot = payoffData[k].slice(len-4, len)
        } else {
            dataPlot = payoffData[k]
        }

        // Plot all the lines
        var city3 = payoff.selectAll(".city3")
            .data(dataPlot)
          .enter().append("g")
            .attr("class", "city3");

        city3.append("path")
            .attr("id", function(d,i) {return cities[k].name;})
            .attr("d", function(d) { return line3(d); })
            .style("stroke", function(d,i) {
                if (i == dataPlot.length-1) {
                    return color(cities[k].name);
                } else {return "maroon";}    
            })
            .style("opacity", 0)
            .transition().duration(1500)
            .style("opacity", 1)
            .style("fill", "none")
            .style("stroke-dasharray", function(d,i){
                if (i == dataPlot.length-1) {
                    return 0,0;}
                else {return 5,5}
            })
            .style("stroke-width", "1.5px");
      
      // Transition the x and y axis
        payoff.select(".x.axis").transition().duration(1000)
              .call(xAxis3)
              .attr("transform", "translate(0," + height3*intersection+ ")");
        payoff.select(".y.axis").transition().duration(1000).call(yAxis3);

      // Remove the profit line, gets recalculated anyway MAY GO AWAY
      } else {
        x3.domain([thisPrice[k]-40,thisPrice[k]+40]);
        y3.domain([0,0]);
        payoff.select(".x.axis").transition().duration(1000)
              .call(xAxis3)
              .attr("transform", "translate(0," + height3*0.5+ ")");
        payoff.select(".y.axis").transition().duration(1000).call(yAxis3);}

  }

// ------------------------------------------------------------------
// Payoff Legend
// ------------------------------------------------------------------
  
  // Main element
  var payoffLegend = svg.append("g")
    .attr("class", "payoffLegend")
    
  // Name and color stock
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 450)
      .style("fill", color(cities[k].name))
      .text(cities[k].name)

  // Amount of stocks
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 470)
      .text(thisAmount[k] +" stocks")

  // Amount of options
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 490)
      .text(thisAmount[k] +" options")

  // Dynamically change the color and amounts
  window.payoffLegendName = function() {
      payoffLegend.select("text:nth-child(1)")
                  .style("fill", color(cities[k].name))
                  .text(cities[k].name)

      if (allData[k]["shares"] === undefined) {
          shareAmount = 0
      } else{
          shareAmount = allData[k]["shares"]
      }
      payoffLegend.select("text:nth-child(2)")
                  .text(shareAmount +" stocks")
      num = 0
      for (i = 0;i < Object.keys(allData[k]).length; i++){
          if (Object.keys(allData[k])[i] != "shares"){
              num += Math.abs(allData[k][Object.keys(allData[k])[i]][0])
          }
      }
      num = parseInt(num)
      if (num == 1) {
          payoffLegend.select("text:nth-child(3)")
                  .text(num +" option")
      } else {
          payoffLegend.select("text:nth-child(3)")
                  .text(num +" options")
      }
    }

// ------------------------------------------------------------------
// Bar Chart
// ------------------------------------------------------------------ 

  function optionbars(){
      // Every stock has a different amount of put/call options, so
      // we have to recalculate both the domains again.
      document.getElementById("optCounterPut").style.visibility = "hidden"
      document.getElementById("optCounterCall").style.visibility = "hidden"

      // Initialise variables
      strikesCall = [];
      pricesCall = [];
      strikesPut = [];
      pricesPut = [];
      // Append all the prices and strikes for the calls and the puts
      for (i=0; i<optionsJSON[cities[k].name].call.length; i++){
        strikesCall.push(optionsJSON[cities[k].name].call[i].strike)
        pricesCall.push(optionsJSON[cities[k].name].call[i].price*100)
      }
      for (i=0; i<optionsJSON[cities[k].name].put.length; i++){
        strikesPut.push(optionsJSON[cities[k].name].put[i].strike)
        pricesPut.push(optionsJSON[cities[k].name].put[i].price*100)
      }
      // Join the put and call prices in one array
      prices = pricesCall.concat(pricesPut);
      strikes = strikesCall.concat(strikesPut);

      // Find the domains of this data
      xbar.domain([0, d3.max(prices)]);
      ybar1.domain(strikesCall);
      ybar2.domain(strikesPut);

      // Remove old bars and axes
      chart1.selectAll(".bar").remove()
      chart2.selectAll(".bar2").remove()
      chart1.select(".y.axis").remove()
      chart2.select(".y.axis").remove()
      chart1.select(".x.axis").remove()
      chart2.select(".x.axis").remove()
      chart1.select("text").remove()
      chart2.select("text").remove()

      // Create the call bar charts
      chart1.selectAll(".bar")
          .data(optionsJSON[cities[k].name].call)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("y", function(d) {return ybar1(d.strike); })
          .attr("height", ybar1.rangeBand())
          .attr("x", 1)
          .attr("width", function(d) {return xbar(d.price*100); })
          .on("click", function(d,i) {
              // Edit the visibility of the inputs and the text beside them
              document.getElementById("optCounterPut").style.visibility = "hidden"
              document.getElementById("optCounterCall").style.visibility = "visible"
              document.getElementById("optTypeCall").innerHTML = "Buy call option with strike $" +d.strike +" for a price of $" +formatValue(d.price*100)
             // Amount of options is zero if the option is not in the dict
             if (allData[k][d.strike+"c"] === undefined) {
                document.getElementById("numCall").value = 0
            // Amount of options is equal to the first element of the array in the dict
             } else {
                document.getElementById("numCall").value = allData[k][d.strike+"c"][0]
             }
             // Set this option info to the variable 
             optionInfo = d
             console.log(d)
          })
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

      // Create the put bar charts with
      chart2.selectAll(".bar2")
          .data(optionsJSON[cities[k].name].put)
        .enter().append("rect")
          .attr("class", "bar2")
          .attr("y", function(d) {return ybar2(d.strike); })
          .attr("height", ybar2.rangeBand())
          .attr("x", 1)
          .attr("width", function(d) {return xbar(d.price*100); })
          .on("click", function(d,i) {
             // Edit the visibility of the inputs and the text beside them
             document.getElementById("optCounterCall").style.visibility = "hidden"
             document.getElementById("optCounterPut").style.visibility = "visible"
             document.getElementById("optTypePut").innerHTML = "Buy put option with strike $" +d.strike +" for a price of $" +formatValue(d.price*100)
             // Amount of options is zero if the option is not in the dict
             if (allData[k][d.strike+"p"] === undefined) {
                document.getElementById("numPut").value = 0
              // Amount of options is equal to the first element of the array in the dict
             } else {
                document.getElementById("numPut").value = allData[k][d.strike+"p"][0]
             }
             // Set this option info to the variable
             optionInfo = d
          })
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

        // y axis call options
        chart1.append("g")
          .attr("class", "y axis")
          .call(yAxisbar1)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

        chart1.append("text")
          .attr("x", -30)
          .attr("y", -15)
          .attr("dy", ".71em")
          .text("Strike price of Call options")
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

      // y axis put options
      chart2.append("g")
          .attr("class", "y axis")
          .call(yAxisbar2)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

      chart2.append("text")
          .attr("x", -30)
          .attr("y", -15)
          .attr("dy", ".71em")
          .text("Strike price of Put options")
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

      // x axis call options
      chart1.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + heightbar + ")")
          .call(xAxisbar)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

      // x axis put options
      chart2.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + heightbar + ")")
          .call(xAxisbar)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

  }

// ------------------------------------------------------------------
// END OF D3.JSON(){}
// ------------------------------------------------------------------
});
  // Remove old slider and append a new slider with the 
  // amount of shares are invested
  function editSlider(){
    d3.select("#slider").remove()
    d3.select("body").append("input")
    .attr("id", "slider")
    .attr("type", "range")
    .attr("min", -20)
    .attr("max", 20)
    .attr("value", thisAmount[k]/5)
    .style("visibility", "visible")
    .on("change", function() {
          allData[k]["shares"] = this.value*5
          payoffResult()
          payoffLegendName()
          moneyLeft()
    }); 
  }

// ------------------------------------------------------------------
// Brush function
// ------------------------------------------------------------------

  // Horizontal brush
  function brushedx() {
      // Set the main x domain to the brushed domain
      x.domain(brushx.empty() ? x2.domain() : brushx.extent());
      console.log(brushx.extent())
      // Transition back to normal if the brush is empty
      if (brushx.empty()) {
          main.select(".x.axis")
              .transition().duration(1000)
              .call(xAxis);
          for (i = 0; i<cities.length; i++) {
              main.select("#"+cities[i].name)
                  .transition().duration(1000)
                  .attr("d", function(d){return line1(d.values)});
          };
      //Edit the main graph to the extent of the brush
      } else {
          main.select(".x.axis").call(xAxis);
          for (i = 0; i<cities.length; i++) {
              main.select("#"+cities[i].name)
                  .attr("d", function(d){return line1(d.values)});
          };
      }
  }

  // Vertical brush
  function brushedy() {
      // Set the main y domain to the brushed domain
      y.domain(brushy.empty() ? y4.domain() : brushy.extent());
      // Transition back to normal if the brush is empty
      if (brushy.empty()) {
          main.select(".y.axis")
              .transition().duration(1000)
              .call(yAxis);
          for (i = 0; i<cities.length; i++) {
              main.select("#"+cities[i].name)
                  .transition().duration(1000)
                  .attr("d", function(d){return line1(d.values)});
          };
      // Edit the main graph to the extent of the brush
      } else {
          main.select(".y.axis").call(yAxis);
          for (i = 0; i<cities.length; i++) {
              main.select("#"+cities[i].name).attr("d", function(d){return line1(d.values)});
          };
      }
  }

// ------------------------------------------------------------------
// Strats NOT FUNCTIONAL YET!!!!!
// ------------------------------------------------------------------
    
    function bullSpread() {
      allData[k] = {}
      if (document.getElementById("bull").checked) {
          difference = 10000
          for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
            thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
            if (thisDifference < difference) {
              difference = thisDifference
              longStrike = optionsJSON[cities[k].name].call[i].strike
              longPrice = optionsJSON[cities[k].name].call[i].price
            }
            if (i == optionsJSON[cities[k].name].call.length-1) {
                shortStrike = optionsJSON[cities[k].name].call[i].strike
                shortPrice = optionsJSON[cities[k].name].call[i].price
                allData[k][shortStrike+"c"] = [-1, shortPrice*100]
            }

          }
          allData[k][longStrike+"c"] = [1, longPrice*100]
          payoffResult()
      } 
    }

    function bearSpread() {
      allData[k] = {}
      if (document.getElementById("bear").checked) {
          difference = 10000
          for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
            thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
            if (thisDifference < difference) {
              difference = thisDifference
              longStrike = optionsJSON[cities[k].name].call[i].strike
              longPrice = optionsJSON[cities[k].name].call[i].price
            }
            if (i == 0) {
                shortStrike = optionsJSON[cities[k].name].call[i].strike
                shortPrice = optionsJSON[cities[k].name].call[i].price
                allData[k][shortStrike+"c"] = [-1, shortPrice*100]
            }

          }
          allData[k][longStrike+"c"] = [1, longPrice*100]
          payoffResult()
      } 
    }

    function butterflySpread() {
      allData[k] = {}
      if (document.getElementById("butterfly").checked) {
          difference = 10000
          for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
            thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
            if (thisDifference < difference) {
              difference = thisDifference
              shortStrike = optionsJSON[cities[k].name].call[i].strike
              shortPrice = optionsJSON[cities[k].name].call[i].price
              shortIndex = i
            }
          }
          if (k == 3) {
            shortIndex -= 1
            shortStrike = optionsJSON[cities[k].name].call[shortIndex].strike
            shortPrice = optionsJSON[cities[k].name].call[shortIndex].price
          }
          longPrice1 = optionsJSON[cities[k].name].call[shortIndex-2].price
          longStrike1 = optionsJSON[cities[k].name].call[shortIndex-2].strike
          longPrice2 = optionsJSON[cities[k].name].call[shortIndex+2].price
          longStrike2 = optionsJSON[cities[k].name].call[shortIndex+2].strike

          allData[k][shortStrike+"c"] = [-2, shortPrice*100]
          allData[k][longStrike1+"c"] = [1, longPrice1*100]
          allData[k][longStrike2+"c"] = [1, longPrice2*100]
          payoffResult()
      } 
    }

    function strangleSpread() {
      allData[k] = {}
      if (document.getElementById("strangle").checked || document.getElementById("straddle").checked) {

          differenceCall = 10000
          for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
            if (document.getElementById("strangle").checked) {
              thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike-5)
            } else {
              thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
            }
            if (thisDifference < differenceCall) {
              differenceCall = thisDifference
              longStrikeCall = optionsJSON[cities[k].name].call[i].strike
              longPriceCall = optionsJSON[cities[k].name].call[i].price
            }
          }
          differencePut = 10000
          for (i = 0; i < optionsJSON[cities[k].name].put.length; i++){
            thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].put[i].strike)
            if (thisDifference < differencePut) {
              differencePut = thisDifference
              longStrikePut = optionsJSON[cities[k].name].put[i].strike
              longPricePut = optionsJSON[cities[k].name].put[i].price
            }
          }
          allData[k][longStrikeCall+"c"] = [1, longPriceCall*100]
          allData[k][longStrikePut+"p"] = [1, longPricePut*100]
          payoffResult()
      } 
    }

// ------------------------------------------------------------------
// Money left
// ------------------------------------------------------------------
  
  function moneyLeft() {
    totalInvestment = 40000
    // for each stock
    for (i = 0; i < allData.length; i++) {
      // for each element in the stock
        for (j = 0; j < Object.keys(allData[i]).length; j++) {
            if (Object.keys(allData[i])[j] == "shares") {
              totalInvestment -= allData[i][Object.keys(allData[i])[j]]*thisPrice[i]
            } else {
              totalInvestment -=allData[i][Object.keys(allData[i])[j]][0]*
                                allData[i][Object.keys(allData[i])[j]][1]
            }
        }
    }
    // Set the amout of money left on the HTML page
    document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)
  }

// ------------------------------------------------------------------
// Investment results
// ------------------------------------------------------------------

  // Results 
  function results() {
      newPrice = thisPrice.slice();
      for (i = 0; i < thisPrice.length; i++) {
          for (j = 0; j<10; j++) {
              newPrice[i] += Math.random()*2-1;
          }
      }
      prof = 0
      for (i = 0; i < thisPrice.length; i++) {
          prof += parseInt(thisAmount[i])*(newPrice[i]-thisPrice[i]);
      }
      if (prof > 0) {alert("You made a profit of: $" +prof.toFixed(2))}
      else {prof = -prof; alert("You made a loss of: $" +prof.toFixed(2))}
  }

  function optGraphPut() {
      // Set the amount of put options of specific strike in the data list
      amountOpts = document.getElementById("numPut").value
      allData[k][optionInfo.strike+"p"] = [amountOpts, optionInfo.price*100]
      payoffResult()
      payoffLegendName()
      moneyLeft()
  }

  function optGraphCall() {
      // Set the amount of call options of specific strike in the data list
      amountOpts = document.getElementById("numCall").value
      allData[k][optionInfo.strike+"c"] = [amountOpts, optionInfo.price*100]
      payoffResult()
      payoffLegendName()
      moneyLeft()
  }
var numtour = 1
// ------------------------------------------------------------------
// Tour of visualisation
// ------------------------------------------------------------------
  function tour() {
    if (numtour != 1) {
      document.getElementById("help_"+(numtour-1)).style.visibility = "hidden"
    }
    document.getElementById("help_"+numtour).style.visibility = "visible"
    numtour += 1
    if (numtour == 9) {
      numtour = 1
    }

  }
  console.log(document.getElementsByName("strategy"))

// ------------------------------------------------------------------
// END OF JAVASCRIOT
// ------------------------------------------------------------------

</script>
<div id="vistour" onclick="tour()">
  <div id="help_1" class="box" onclick="tour()">
    <p>Hello, and welcome to my visualisation<br>The first thing we can see here is a stock graph. This is a reference for what you want to invest in. </p>
  </div>

  <div id="help_2" class="box">
    <p>The legend is a main part in this visualisation. By clicking on one of the legend names the line for this stock will light up, and you can invest in this stock!</p>
  </div>

  <div id="help_3" class="box">
    <p>Want to inspect a part of the graph in more detail, then you can zoom in either in the x or the y axis with the two areas under and beside the bar</p>
  </div>

  <div id="help_4" class="box">
    <p>This section is the payoff graph, after investing in either shares or options of a specific stock, the dotted lines will show them. The solid line will display the combined profit. <br>Note: Only 5 lines will be shown!</p>
  </div>

  <div id="help_5" class="box">
    <p>We can see here in what stock we are currently investing, how much money we have left, what the current stock price of the selected stock is, and if we want to finalise our investment.</p>
  </div>

  <div id="help_6" class="box">
    <p>Finally this section displays all the possible ways we can invest in a stock. If you still do not know what options and shares are, I refer you to the "About" button in the navigation bar. Also note that EVERY trade costs you $20.</p>
  </div>

  <div id="help_7" class="box">
    <p>The first is investing in shares of the company, where the payoff will be linear</p>
  </div>

  <div id="help_8" class="box">
    <p>The the second is investing in option strategies. I advise you not to combine strategies</p>
  </div>

  <div id="help_9" class="box">
    <p>We finally have the option to invest in single options. But pay attention to your money, because it can drop rapidly (shorting shares will decrease the price of the option by 10%)</p>
  </div>

</div>
<div id="verticalline"></div>
<div id="horizontalline"></div>

<form id="strats">
<input id="bull" type="radio" name="strategy" value="Bear" onchange="bullSpread()">Bull Spread<br>
<input id="bear" type="radio" name="strategy" value="Bull" onchange="bearSpread()">Bear Spread<br>
<input id="butterfly" type="radio" name="strategy" value="butterfly" onchange="butterflySpread()">Butterfly Spread<br>
<input id="strangle" type="radio" name="strategy" value="strangle" onchange="strangleSpread()">Strangle Spread<br>
<input id="straddle" type="radio" name="strategy" value="Bear" onchange="strangleSpread()">Straddle Spread<br>
</form>
Hidden elements and make visible when a button is clicked
