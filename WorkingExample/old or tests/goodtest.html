<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}
.city {
  clip-path: url(#clip);
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

.legend {
  padding: 5px;
  font: 10px sans-serif;
  background: yellow;
  box-shadow: 2px 2px 1px #888;
}

#investOppert {
    float:right;
    clear:right;
    border:1px solid #aaa;
    display: inline-block;
    word-wrap: break-word;
    width:250px;
    height:300px;
    background-color:#f9f9f9;
    padding-left:10px;
    padding-right:10px;
    margin-right: 50px;
    margin-left:50px;
    margin-top:30px;
    text-align: center;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script>
// First one
var optionsJSON;

// Some random variables I'm using
var k = 0,
    dateToMaturity = 20,
    thisAmount = [0,0,0,0,0,0,0,0],
    newPrice = [0,0,0,0,0,0,0,0],
    thisPrice = [],
    cities = 0,
    totalInvestment = 100000,
    strUser = "";
 
// Margins   
var margin = {top: 20, right: 100, bottom: 400, left: 130},
    margin2 = {top: 330, right: 10, bottom: 320, left: 130},
    margin3 = {top: 450, right: 100, bottom: 30, left: 50},
    margin4 = {top: 20, right: 730, bottom: 400, left: 30};

// Width and heights
var width = 825 - margin.left - margin.right,
    width3 = 825 - margin3.left - margin3.right,
    width4 = 825 - margin4.left - margin4.right,

    height = 700 - margin.top - margin.bottom,
    height2 = 700 - margin2.top - margin2.bottom,
    height3 = 700 - margin3.top - margin3.bottom,
    height4 = 700 - margin4.top - margin4.bottom;

// Date and money elements
var parseDate = d3.time.format("%d-%m-%Y").parse,
    bisectDate = d3.bisector(function(d) { return d.date; }).left,
    formatValue = d3.format(",.2f"),
    formatCurrency = function(d) { return "$" + formatValue(d); };

// Colors
var color = d3.scale.category10();

// Scaling
var x = d3.time.scale().range([0, width]),
    x2 = d3.time.scale().range([0, width]),
    x3 = d3.scale.linear().range([0,width3]),
    x4 = d3.time.scale().range([0, width4]),

    y = d3.scale.linear().range([height, 0]),
    y2 = d3.scale.linear().range([height2, 0]),
    y3 = d3.scale.linear().range([height3, 0]),
    y4 = d3.scale.linear().range([height4, 0]);

// Axes
var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom"),
    xAxis3 = d3.svg.axis().scale(x3).orient("bottom"),
    xAxis4 = d3.svg.axis().scale(x4).orient("bottom"),

    yAxis = d3.svg.axis().scale(y).orient("left");
    yAxis3 = d3.svg.axis().scale(y3).orient("left");
    yAxis4 = d3.svg.axis().scale(y4).orient("left");

// Horizontal and vertical brushes
var brushx = d3.svg.brush()
    .x(x2)
    .on("brush", brushedx);

var brushy = d3.svg.brush()
    .y(y4)
    .on("brush", brushedy);

// 4 Lines I'm using
var line1 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.price); });

var line2 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x2(d.date); })
    .y(function(d) { return y2(d.price); });

var line3 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x3(d.key); })
    .y(function(d) { return y3(d.price); });

var line4 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x4(d.date); })
    .y(function(d) { return y4(d.price); });

// Appending the SVG element
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

// Clip path for when using the brush
svg.append("defs").append("clipPath")
    .attr("id", "clip")
  .append("rect")
    .attr("width", width)
    .attr("height", height);

// Main element where the stock charts are in
var main = svg.append("g")
    .attr("class", "main")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Two brush elements
var xBrush = svg.append("g")
    .attr("class", "xBrush")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

var yBrush = svg.append("g")
    .attr("class", "yBrush")
    .attr("transform", "translate(" + margin4.left + "," + margin4.top + ")");

// Payoff element
var payoff = svg.append("g")
    .attr("class", "payoff")
    .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")")

// Tooltip main graph
var toolTip1 = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .style("display", "none");

// Load option data (NOT USING YET)
d3.json("optionsDataBetter.json", function(data) {console.log(data); optionsJSON = data;})

// Main data
d3.json("AllData.json", function(error, data) {
  // Color domain are all names in the data except the date
  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  // Parse the date
  data.forEach(function(d) {d.date = parseDate(d.date); });

  // Sort the date
  data.sort(function(a, b) {
    return a.date - b.date;});

  // Assign the cities a color and map the values 
  cities = color.domain().map(function(name) {
      return {
          name: name,
          values: data.map(function(d) {
              return {date: d.date, price: +d[name]};
          })
      };
  });

  // Last known price for all stocks in one array
  for (i = 0; i < cities.length; i++) {
    thisPrice.push(cities[i].values[(cities[i].values).length-1].price)
  }

// ------------------------------------------------------------------
// Domains
// ------------------------------------------------------------------
  // x,x2,x4 and y,y2,y4 domains
  x.domain(d3.extent(data, function(d) { return d.date; }));

  y.domain([
    0,
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.price; }); })
  ]);

  x2.domain(x.domain());
  y2.domain(y.domain());
  x4.domain(x.domain());
  y4.domain(y.domain());

// ------------------------------------------------------------------
// Main graph
// ------------------------------------------------------------------
  // Place the x axis
  main.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  // Place the y axis
  main.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("price (ÂºF)");

  // Place all the stocks
  var city = main.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("id", function(d,i) {return d.name})
      .attr("d", function(d) { return line1(d.values); })
      .style("stroke", function(d) { return color(d.name); })
      .style("fill", "none")
      .style("stroke-width", "1.5px");

// ------------------------------------------------------------------
// Legend
// ------------------------------------------------------------------

  // Spacing between legend
  space = height/cities.length

  // Add the main legend class
  var legend = svg.append("g")
    .attr("class", "legend") 
      
  // Add all the names with appropriate spacing  
  legend.selectAll('text')
    .data(cities)
    .enter()
    .append("text")
    .attr("id", function(d,i) {return d.name})
    .attr("x", width+ margin.left +10)
    .attr("y", function(d, i){ return (i+0.5) * space + margin.top;})
    .style("fill", function(d) {return color(d.name)})
    .text(function(d) { return d.name;})
    .on("click", function(d, i){

          // Set variable to active or inactive and denote the current stock index
          var active  = d.active ? false : true;
          d.active = active
          k = i
          // Call functions that depent on activation of stock
          payoffResult()
          stockInvest()
          payoffLegendName()
          // Edit the information on the page
          document.getElementById("money").innerHTML = "Money left: $" +totalInvestment
          document.getElementById("stock").innerHTML = "Investing in " +cities[k].name;
          document.getElementById("stockPrice").innerHTML = "Current price  " +thisPrice[k];
          if (strUser == "shares") {
              document.getElementById("amount").value = thisAmount[k]
          }
          // When active
          if (active == true) {
              // Values for the line, and change the line
              onOpacity = 5;
              offOpacity = 2;
              legend.select("#"+d.name)
                    .transition().duration(1000)
                    .style("font-size","15px")
                    .style("font-weight","bold")
              d3.select("#"+d.name.replace(/\s+/g, ''))
                  .transition().duration(1000) 
                  .style("stroke-width", onOpacity)
                  .style("opacity", 1);
              // Put all stocks except this one to false
              for (j = 0; j < cities.length; j++) {
                  if (j != i) {
                      d3.select("#"+cities[j].name)
                        .transition().duration(1000) 
                        .style("stroke-width", offOpacity)
                        .style("opacity", 0.5);

                      legend.select("#"+cities[j].name)
                        .transition().duration(1000)
                        .style("font-size","10px")
                        .style("font-weight","normal")
                        cities[j].active = false;
                  };
              };
            // Change all the lines to normal if none are active
          } else {
              for (j = 0; j < cities.length; j++) {
                  d3.select("#"+cities[j].name)
                    .transition().duration(1000) 
                    .style("stroke-width", 2)
                    .style("opacity", 1);

                  legend.select("#"+cities[j].name)
                        .transition().duration(1000)
                        .style("font-size","10px")
                        .style("font-weight","normal")
              }
          }
    });
// ------------------------------------------------------------------
// Brush X Section
// ------------------------------------------------------------------
  
  // Place the x axis for the horizontal brush
  xBrush.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);  

  // Place all the stocks
  var city2 = xBrush.selectAll(".city2")
      .data(cities)
    .enter().append("g")
      .attr("class", "city2")

  city2.append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line2(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  xBrush.append("g")
      .attr("class", "x brush")
      .call(brushx)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height2 + 7);  

// ------------------------------------------------------------------
// Brush Y Section
// ------------------------------------------------------------------
  
  // Place the y axis for the vertical brush
  yBrush.append("g")
      .attr("class", "y axis")
      .call(yAxis4)
    .append("text")
      .attr("transform", "rotate(-90)")

  // Place all the stocks
  var city3 = yBrush.selectAll(".city3")
      .data(cities)
    .enter().append("g")
      .attr("class", "city3")

  city3.append("path")
      .attr("class", "line")
      .attr("d", function(d) {return line4(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  yBrush.append("g")
      .attr("class", "y brush")
      .call(brushy)
    .selectAll("rect")
      .attr("x", -6)
      .attr("width", width4)

// ------------------------------------------------------------------
// Tooltip Thing
// ------------------------------------------------------------------

  // Add a circle for the tooltip
  toolTip1.append("circle")                                 
      .attr("class", "y")                                
      .style("fill", "none")                             
      .style("stroke", "black")                           
      .attr("r", 4);

  // Add the text for the tooltip
  toolTip1.append("text")
      .attr("class", "y2")
      .attr("dx", -2)
      .attr("dy", -10)
      .style("font-size", "15px");

  // Rectangle for when the tooltip shows if the mouse is on it
  main.append("rect")                                     
      .attr("width", width)                              
      .attr("height", height+margin.bottom/3)                            
      .style("fill", "none")                             
      .style("pointer-events", "all")                    
      .on("mouseover", function() { toolTip1.style("display", null); })
      .on("mouseout", function() { toolTip1.style("display", "none"); })
      .on("mousemove", mousemove); 

  // Function for when the mouse moves on the rectangle
  function mousemove() {
    // Get the date, its index, values left and right of the date and the intrapolation
    var mouseDate = x.invert(d3.mouse(this)[0]),              
        i = bisectDate(cities[k].values, mouseDate, 1),                   
        d0 = cities[k].values[i - 1],                              
        d1 = cities[k].values[i],                            
        d = mouseDate - d0.date > d1.date - mouseDate ? d1 : d0;
    
    // Move the circle on the graph where the mouse is
    toolTip1.select("circle.y")                           
        .attr("transform",                             
              "translate(" + x(d.date) + "," +         
                             y(d.price) + ")");

    // Place the price above of the circle
    toolTip1.select("text.y2")
        .attr("transform",
              "translate(" + x(d.date) + "," +
                             y(d.price) + ")")
        .text(formatCurrency(d.price));   
    }

// ------------------------------------------------------------------
// Payoff graph
// ------------------------------------------------------------------ 

  // Initial empty graph
  x3.domain([0,0]);
  y3.domain([0,0]);
  payoffData = [[],[],[],[],[],[],[],[]]

  // Append an empty line
  payoff.append("path")
      .datum(payoffData[k])
      .attr("class", "line")
      .attr("d", line3)
      .style("stroke-dasharray", 5.5);

  // Place the x axis
  payoff.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height3/2 + ")")
      .call(xAxis3)
      .append("text")
      .attr("y", 35)
      .attr("x", width3-30)
      .text("price ($)");

  // place the y axis
  payoff.append("g")
      .attr("class", "y axis")
      .call(yAxis3)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("profit ($)");

  // Hardcoded option data as an example
  var strikeLow = 312,
      strikeLowPrice = 9.5,
      strikeHigh = 330,
      strikeHighPrice = 22.05;

  // I actually have no idea what this is
  window.finalPrice = function() {
    payoff.select(".end")
          .attr("transform",                             
              "translate(" + x3(newPrice[k]) + "," +         
                             0 + ")")
  }    

  // Graph after update (Not really that great atm) 
  window.payoffResult = function() {
    finalPrice()
    // Data
    shares = 0
    callprice = -3
    payoffData[k] = [[],[]]
    type1 = 0
    // Line 1
    for (i=-20; i<=20; i++){
        payoffData[k][0].push({
          name: "shares",
          key: thisPrice[k] + i,
          price: i*thisAmount[k]
        })
    };
    // Line 2
    for (i=-20; i<=20; i++){
        payoffData[k][1].push({
          name: "shares",
          key: thisPrice[k] + i,
          price: i*thisAmount[k]*2
          })
      };
    // line call amazon 312
    // for (i = strikeLow-5; i < strikeLow +5; i++){

    // }



    // Find the highest and lowest values
    yMax = 0;
    yMin = 0;
    dom = []
    for (i = 0; i<payoffData[k].length; i++) {
        for (j = 0; j < payoffData[k][i].length; j++) {
            if (payoffData[k][i][j].price < yMin) {yMin = payoffData[k][i][j].price}
            else if (payoffData[k][i][j].price > yMax) {yMax=payoffData[k][i][j].price}
        } 
    };
    dom = [yMin, yMax]

    // Set the domains
    x3.domain(d3.extent(payoffData[k][type1], function(d) { return d.key; }));
    y3.domain(dom);

    //intersection =  Math.abs(dom[1])/(Math.abs(dom[1])+Math.abs(dom[0]))
    // Edit the payoff line and axes
    //for (i=0; i<payoffData[k].length; i++) {
    if (payoffData[k][type1][0].name == "shares") {
      payoff.select(".line")
            .data([payoffData[k][type1]])
            .transition().duration(1000)
            .attr("d", line3)
            .style("stroke", function() {
              if (thisAmount[k] == 0) {return "white";}
              else {return color(cities[k].name);}
            });
      payoff.select(".x.axis").transition().duration(1000).call(xAxis3)
      payoff.select(".y.axis").transition().duration(1000).call(yAxis3)
    } else if (payoffData[0].name == "option") {

    } else {

    }
  }

// ------------------------------------------------------------------
// Payoff Legend
// ------------------------------------------------------------------
  
  // Main element
  var payoffLegend = svg.append("g")
    .attr("class", "payoffLegend")
    
  // Name and color stock
  payoffLegend.append("text")
      .attr("x", width3 +margin3.left +10)
      .attr("y", 450)
      .style("fill", color(cities[k].name))
      .text(cities[k].name)

  // Amount of stocks
  payoffLegend.append("text")
      .attr("x", width3 +margin3.left +10)
      .attr("y", 470)
      .text(thisAmount[k] +" stocks")

  // Amount of options
  payoffLegend.append("text")
      .attr("x", width3 +margin3.left +10)
      .attr("y", 490)
      .text(thisAmount[k] +" options")

  // Dynamically change the color and amounts
  window.payoffLegendName = function() {
      payoffLegend.select("text:nth-child(1)")
                  .style("fill", color(cities[k].name))
                  .text(cities[k].name)
      payoffLegend.select("text:nth-child(2)")
                  .text(thisAmount[k] +" stocks")
    }

// ------------------------------------------------------------------
// END OF D3.JSON(){}
// ------------------------------------------------------------------
});

// ------------------------------------------------------------------
// Brush function
// ------------------------------------------------------------------

  // Horizontal brush
  function brushedx() {
      // Set the main x domain to the brushed domain
      x.domain(brushx.empty() ? x2.domain() : brushx.extent());
      // Edit the x axis and the lines
      main.select(".x.axis").call(xAxis);
      for (i = 0; i<cities.length; i++) {
          main.select("#"+cities[i].name).attr("d", function(d){return line1(d.values)});
      };
  }

  // Vertical brush
  function brushedy() {
      // Set the main y domain to the brushed domain
      y.domain(brushy.empty() ? y4.domain() : brushy.extent());
      // Edit the y axis and the lines
      main.select(".y.axis").call(yAxis);
      for (i = 0; i<cities.length; i++) {
          main.select("#"+cities[i].name).attr("d", function(d){return line1(d.values)});
      };
  }

// ------------------------------------------------------------------
// Type of investments 
// ------------------------------------------------------------------
  
  // Some edits in the investment box
  function stockInvest() {
      e = document.getElementById("investmentType");
      strUser = e.options[e.selectedIndex].text;
      if (strUser === "Shares") {
          document.getElementById("otype").innerHTML = '<br><input type="text" id="amount" onkeypress="searchKeyPress(event);">'
      } else if (strUser === "Option Strategy") {
          document.getElementById("otype").innerHTML = '<input type="checkbox" name="option" value="call">Call <input type="checkbox" name="option" value="put">Put'
      } else {
          document.getElementById("otype").innerHTML = "List of all the options and you can check some"
      }
  }

// ------------------------------------------------------------------
// Enter key in search field
// ------------------------------------------------------------------

  // Some edits when pressing the enter key
  function searchKeyPress(e) {
      if (e.keyCode == 13) {   
          totalInvestment = 100000;
          thisAmount[k] = document.getElementById("amount").value;
          for (i = 0; i< cities.length; i++){
              totalInvestment -= (thisPrice[i]*thisAmount[i])  
          }        
          document.getElementById("money").innerHTML = "Money left: $" +totalInvestment.toFixed(2)
          payoffResult();
          payoffLegendName()
          if (totalInvestment < 0) {alert("Not enough money")}
      }
  };

// ------------------------------------------------------------------
// Investment results
// ------------------------------------------------------------------

  // Results 
  function results() {
      newPrice = thisPrice.slice();
      for (i = 0; i < thisPrice.length; i++) {
          for (j = 0; j<10; j++) {
              newPrice[i] += Math.random()*2-1;
          }
      }
      prof = 0
      for (i = 0; i < thisPrice.length; i++) {
          prof += parseInt(thisAmount[i])*(newPrice[i]-thisPrice[i]);
      }
      finalPrice();
      if (prof > 0) {alert("You made a profit of: $" +prof.toFixed(2))}
      else {prof = -prof; alert("You made a loss of: $" +prof.toFixed(2))}
  }

// ------------------------------------------------------------------
// END OF JAVASCRIOT
// ------------------------------------------------------------------

</script>
<div id="investOppert">
    <h2 id="stock">No stock selected</h2>
    <p id="money"></p>
    <p>Choose your investment type<p>
    <select id="investmentType" onclick="stockInvest()">
    <option value="value1" checked>Shares</option>
    <option value="value2">Option Strategy</option>
    <option value="value3">Single Option</option>
    </select>
    <p id="investType"></p>
    <p id="stockPrice"></p>
    <p id="otype"></p>
    <button onclick="results()">Invest!</button>
</div>