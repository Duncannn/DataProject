<!DOCTYPE html>
<meta charset="utf-8">
<style>
.nextBut {
   opacity: 0.7;
   padding: 2px 4px;
   border:solid 1px #343634; 
   background-color: maroon;
   color:white;
}
.nextBut:hover{
  opacity: 1;
}
.exitBut {
  opacity: 0.8;
  float:right;
  font-weight: bold;
}
.exitBut:hover {
  opacity: 1;
  float:right;
  font-weight: bold;
}

.button{
   opacity: 0.7;
   text-decoration:none; 
   text-align:center; 
   padding:19px 17px; 
   border-left:solid 1px #343634; 
   border-right:solid 1px #343634;
   -webkit-border-radius:4px;
   -moz-border-radius:4px; 
   font:18px Arial, Helvetica, sans-serif; 
   color:#E5FFFF;  }

.button:hover{
  opacity: 1;
  border-left:solid 1px black; 
   border-right:solid 1px black;
  }

#investClear {
  position: absolute;
  left:1200px;
  top:225px;
}
#stockClear {
  position: absolute;
  left:925px;
  top:225px;
}

.box {
  width:400px;
  background-color: #eee;
  border: 2px solid #333;
  border-radius: 5px;
  color: #333;
  display: inline-block;
  font: 14px sans-serif;
  padding: 6px 12px;
  position: relative;
  z-index: 1000;
}
.bubble1 {
    width:300px;
    background-color: #eee;
    border: 2px solid #333;
    border-radius: 5px;
    color: #333;
    display: inline-block;
    font: 14px sans-serif;
    padding: 12px;
    position: relative;
    z-index: 1000;
}

.bubble {
    width:300px;
    background-color: #eee;
    border: 2px solid #333;
    border-radius: 5px;
    color: #333;
    display: inline-block;
    font: 14px/16px sans-serif;
    padding: 6px 12px;
    position: relative;
    z-index: 1000;
}
.bubble:after,
.bubble:before {
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 20px solid #eee;
    bottom: -20px;
    content: '';
    left: 15%;
    margin-left: -20px;
    position: absolute;
}

/* Styling for second triangle (border) */

.bubble:before {
    border-left: 23px solid transparent;
    border-right: 23px solid transparent;
    border-top: 23px solid;
    border-top-color: inherit; /* Can't be included in the shorthand to work */
    bottom: -23px;
    margin-left: -23px;
}

.bubble2 {
    width:300px;
    background-color: #eee;
    border: 2px solid #333;
    border-radius: 5px;
    color: #333;
    display: inline-block;
    font: 14px/16px sans-serif;
    padding: 6px 12px;
    position: relative;
    z-index: 1000;
}
.bubble2:after,
.bubble2:before {
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-bottom: 20px solid #eee;
    top: -20px;
    content: '';
    left: 50%;
    margin-left: -20px;
    position: absolute;
}

/* Styling for second triangle (border) */

.bubble2:before {
    border-left: 23px solid transparent;
    border-right: 23px solid transparent;
    border-bottom: 23px solid;
    border-bottom-color: inherit; /* Can't be included in the shorthand to work */
    top: -23px;
    margin-left: -23px;
}

#terms {
  visibility: hidden;
  position:absolute;
  left:200px;
  top:80px;
}

#about_1 {
  visibility: hidden;
  position:absolute;
  left:200px;
  top:80px;
}

#about_2 {
  visibility: hidden;
  position:absolute;
  left:200px;
  top:80px;
}

#about_3 {
  visibility: hidden;
  position:absolute;
  left:200px;
  top:80px;
}

#optCounterCall{
  visibility: hidden;
  position: absolute;
  left:925px;
  top:400px;
}
#optCounterPut{
  visibility: hidden;
  position: absolute;
  left:925px;
  top:400px;
}

#verticalline{
  position: absolute;
  color:grey;
  top: 70px;
  left: 900px;
  height: 700px;
  border-left: solid;
}

#horizontalline1 {
  position: absolute;
  color:grey;
  left:5px;
  top: 485px;
  width: 895px;
  border-top: solid;
}

#horizontalline2 {
  position: absolute;
  color:grey;
  left:900px;
  top: 210px;
  width: 370px;
  border-top: solid;
}

#help_0 {
  position: absolute;
  left:160px;
  top:45px;
  visibility:hidden;
}

#help_1 {
  position: absolute;
  left:160px;
  top:45px;
  visibility:hidden;
}
#help_2 {
  position: absolute;
  left:625px;
  top:400px;
  visibility:hidden;
}
#help_3{
  position: absolute;
  left:138px;
  top:290px;
  visibility:hidden;
}
#help_4 {
  position: absolute;
  left:925px;
  top:225px;
  visibility:hidden;
}
#help_5 {
  position: absolute;
  left:100px;
  top:350px;
  visibility:hidden;
}
#help_6 {
  position: absolute;
  left:925px;
  top:45px;
  visibility:hidden;
}
#help_7 {
  position: absolute;
  left:925px;
  top:130px;
  visibility:hidden;
}
#help_8 {
  position: absolute;
  left:925px;
  top:150px;
  visibility:hidden;
}
#help_9 {
  position: absolute;
  left:925px;
  top:255px;
  visibility:hidden;
}
#info_1 {
  position: absolute;
  left:900px;
  top:30px;
  visibility:hidden;
}
#info_2 {
  position: absolute;
  left:900px;
  top:10px;
  visibility:hidden;
}
#info_3{
  position: absolute;
  left:900px;
  top:90px;
  visibility:hidden;
}
#info_4 {
  position: absolute;
  left:900px;
  top:45px;
  visibility:hidden;
}
#info_5 {
  position: absolute;
  left:900px;
  top:127px;
  visibility:hidden;
}
#info_6 {
  position: absolute;
  left:900px;
  top:145px;
  visibility:hidden;
}
.bar {
  fill: steelblue;
}

.bar:hover{
  fill:brown;
}

.bar2 {
  fill: steelblue;
}

.bar2:hover{
  fill:brown;
}

div{
  display: block;
}

body {
  font: 10px sans-serif;
  background-color: #f9f9f9;
}
.city {
  clip-path: url(#clip);
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

.legend {
  padding: 5px;
  font: 10px sans-serif;
  background: yellow;
  box-shadow: 2px 2px 1px #888;
}

#investOppert {
    position: absolute; 
    top: 50px;
    left: 900px;
    clear:right;
    display: inline-block;
    word-wrap: break-word;
    width:250px;
    height:200px;
    padding-left:10px;
    padding-right:10px;
    margin-right: 50px;
    margin-left:50px;
    margin-top:30px;
    text-align: center;
}

#slider {
  visibility:hidden;
  position: absolute;
  top: 260px;
  left: 925px;
}

#shareSlider {
  visibility:visible;
  position: absolute;
  top: 262px;
  left: 1070px;
}


#strats {
  visibility:hidden;
  position: absolute;
  top: 290px;
  left: 925px;
}

#navbar {
  width:100%;
  height:60px;
  /*background-color: #802c59;*/
  /*background-color: #1c94c6;    #CCC */
  background-color:maroon;
  border-bottom: 2px solid grey;
}

#headContainer {
  width:900px;
  margin-right: auto;
  margin-left: auto;
}

#name {
  font-size: 16px;
  font-weight: 250;
  color: white;
  padding:3.5px;
}


#nav li {
  display: inline;
  list-style-type: none;
  padding-right: 30px;
}


</style>
<script src="http://d3js.org/d3.v3.js"></script>
<body>
  <div id="navbar">
    <div id="headContainer">
      <div id="name">
        <ul id="nav">
          <li>Visualising Investment Returns</li>
          <li> <a onclick="about()" class="button"/>About</a></li>
          <li> <a onclick="tour()" class="button"/>Tour</a></li>
          <li> <a onclick="info()" class="button"/>Option Info</a></li>
          <li> <a onclick="document.getElementById('terms').style.visibility = 'visible'"
                  class="button"/>Terms</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="investOppert">
      <h1 id="stock">No stock selected</h1>
      <h2 id="money"></h2>
      <h3 id="stockPrice"></h3>
      <button onclick="results()">Invest!</button> <span> <button onclick="GBMresults()">Invest GBM</button> </span>
  </div>
  <form id="optCounterPut">
    <input id = "numPut" type="number" name="quantity" min="-15" max="15" value="0" onchange="optGraphPut()">
    <span id="optTypePut">Hello</span>
  </form>

  <form id="optCounterCall">
    <input id = "numCall" type="number" name="quantity" min="-15" max="15" value="0" onchange="optGraphCall()">
    <span id="optTypeCall">Buy call option</span>
  </form>


<script>
// VARY THE AMOUNT OF STRATS I CAN BUY
// edit lastPrice into results()
// lastprice only with invested stuff. if payoffdata[k].length !== 0
// EDIT IS NOTHING IS CLICKED, EVERYTHING STAYS....

// First one
var optionsJSON;

// Some global variables I'm using
var k = 0,
    emptyTour = true,
    GBM = false,
    investButton = false,
    activeStock = [0, 0, 0, 0, 0, 0, 0, 0],
    dateToMaturity = 20,
    thisAmount = [0,0,0,0,0,0,0,0],
    shareAmount = 0,
    shareIndex = [0,0,0,0,0,0,0,0],                                     
    thisAmountOpt = [0,0,0,0,0,0,0,0],
    newPrice = [0,0,0,0,0,0,0,0],
    checked_boxes = [-1,-1,-1,-1,-1,-1,-1,-1],
    thisPrice = [],
    lastPrice = [],
    cities = 0,
    numtour = 0,
    numAbout = 0,
    numInfo = 0,
    totalInvestment = 10000,
    strUser = "",
    strike1,
    price1,
    strike2,
    price2,
    remember,
    fullData,
    allData = [{},{},{},{},{},{},{},{}],
    optionInfo = 0;

// Margins   
var margin = {top: 20, right: 525, bottom: 400, left: 130},
    marginxBrush = {top: 330, right: 525, bottom: 320, left: 130},
    marginPayoff = {top: 450, right: 525, bottom: 55, left: 50},
    marginyBrush = {top: 20, right: 1185, bottom: 400, left: 30},
    marginbar = {top:380, right: 20, bottom: 120, left:950};

// Width and heights
//margins right + 135
var width = 1280 - margin.left - margin.right,
    width3 = 1280 - marginPayoff.left - marginPayoff.right,
    width4 = 1280 - marginyBrush.left - marginyBrush.right,
    widthbar = 1280 - marginbar.left - marginbar.right,

    height = 700 - margin.top - margin.bottom,
    height2 = 700 - marginxBrush.top - marginxBrush.bottom,
    height3 = 700 - marginPayoff.top - marginPayoff.bottom,
    height4 = 700 - marginyBrush.top - marginyBrush.bottom;
    heightbar = (700 - marginbar.top - marginbar.bottom)/2;

// Date and money elements
var parseDate = d3.time.format("%d-%m-%Y").parse,
    bisectDate = d3.bisector(function(d) { return d.date; }).left,
    bisectNum = d3.bisector(function(d) {return d.price;}).left,
    formatValue = d3.format(",.2f"),
    formatCurrency = function(d) { return "$" + formatValue(d); };

// Colors
var color = d3.scale.category10();

var eps = d3.random.normal();

// Scaling
var x = d3.time.scale().range([0, width]),
    x2 = d3.time.scale().range([0, width]),
    x3 = d3.scale.linear().range([0,width3]),
    x4 = d3.time.scale().range([0, width4]),
    //xbar = d3.scale.linear().range([widthbar, 0]),
    xbar = d3.scale.linear().range([0, widthbar]),

    y = d3.scale.linear().range([height, 0]),
    y2 = d3.scale.linear().range([height2, 0]),
    y3 = d3.scale.linear().range([height3, 0]),
    y4 = d3.scale.linear().range([height4, 0]),
    ybar1 = d3.scale.ordinal().rangeRoundBands([0, heightbar], .2);
    ybar2 = d3.scale.ordinal().rangeRoundBands([0, heightbar], .2);

// Axes
var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom"),
    xAxis3 = d3.svg.axis().scale(x3).orient("bottom"),
    xAxis4 = d3.svg.axis().scale(x4).orient("bottom"),
    xAxisbar = d3.svg.axis().scale(xbar).orient("bottom").ticks(8),

    yAxis = d3.svg.axis().scale(y).orient("left"),
    yAxis3 = d3.svg.axis().scale(y3).orient("left"),
    yAxis4 = d3.svg.axis().scale(y4).orient("left");
    yAxisbar1 = d3.svg.axis().scale(ybar1).orient("left")
    yAxisbar2 = d3.svg.axis().scale(ybar2).orient("left")

// Horizontal and vertical brushes
var brushx = d3.svg.brush()
    .x(x2)
    .on("brush", brushedx);

var brushy = d3.svg.brush()
    .y(y4)
    .on("brush", brushedy);

// 4 Lines I'm using
var line1 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.price); });

var line2 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x2(d.date); })
    .y(function(d) { return y2(d.price); });

var line3 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x3(d.key); })
    .y(function(d) { return y3(d.price); });

var line4 = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x4(d.date); })
    .y(function(d) { return y4(d.price); });

// SLIDER



// Appending the SVG element
var svg = d3.select("body").append("svg")
    .attr("id","svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

// Clip path for when using the brush
svg.append("defs").append("clipPath")
    .attr("id", "clip")
    .append("rect")
    .attr("width", width)
    .attr("height", height);

// Main element where the stock charts are in
var main = svg.append("g")
    .attr("class", "main")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Two brush elements
var xBrush = svg.append("g")
    .attr("class", "xBrush")
    .attr("transform", "translate(" + marginxBrush.left + "," + marginxBrush.top + ")");

var yBrush = svg.append("g")
    .attr("class", "yBrush")
    .attr("transform", "translate(" + marginyBrush.left + "," + marginyBrush.top + ")");

// Payoff element
var payoff = svg.append("g")
    .attr("class", "payoff")
    .attr("transform", "translate(" + marginPayoff.left + "," + marginPayoff.top + ")");

// Tooltip main graph
var toolTip1 = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .style("display", "none");

// Tooltip payoff graph
var toolTip2 = svg.append("g")
    .attr("transform","translate(" + marginPayoff.left + "," + marginPayoff.top + ")")

// where the small charts are put in
var chart = svg.append("g")
    .attr("class", "chart")
    .attr("transform", "translate(" + marginbar.left +"," +marginbar.top +")");

// Bar chart
var chart1 = svg.append("g")
    .attr("class", "chart1")
    .attr("transform", "translate(" + marginbar.left +"," +marginbar.top +")");
bar2 = +marginbar.top +heightbar+40 
var chart2 = svg.append("g")
    .attr("class", "chart2")
    .attr("transform", "translate(" + marginbar.left +"," +bar2 +")");

document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)

// Load option data (NOT USING YET)
d3.json("optionsDataBetterLess.json", function(data) {optionsJSON = data;})

// Main data
d3.json("finalData.json", function(error, data) {
  // save full data and crop data to 2nd jan.
  fullData = data
  data = data.slice(14,data.length-1)

  // Color domain are all names in the data except the date
  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  // Parse the date
  data.forEach(function(d) {
    d.date = parseDate(d.date);
     });

  // Sort the date
  data.sort(function(a, b) {
    return a.date - b.date;});

  // Assign the cities a color and map the values 
  cities = color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function(d) {
          return {date: d.date, price: +d[name]};
      })
    };
  });

  // Last known price for all stocks in one array
  for (i = 0; i < cities.length; i++) {
    thisPrice.push(cities[i].values[(cities[i].values).length-1].price)
    lastPrice.push(fullData[0][cities[i].name])
  }
// ------------------------------------------------------------------
// Domains
// ------------------------------------------------------------------
  // x,x2,x4 and y,y2,y4 domains
  x.domain(d3.extent(data, function(d) { return d.date; }));

  y.domain([
    0,
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.price; }); })
  ]);

  x2.domain(x.domain());
  y2.domain(y.domain());
  x4.domain(x.domain());
  y4.domain(y.domain());

// ------------------------------------------------------------------
// Main graph
// ------------------------------------------------------------------
  // Place the x axis
  main.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  // Place the y axis
  main.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("price ($)");

  // Place all the stocks
  var city = main.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("id", function(d,i) {;return d.name})
      .attr("d", function(d) { return line1(d.values); })
      .style("stroke", function(d) { return color(d.name); })
      .style("fill", "none")
      .style("stroke-width", "1.5px");

// ------------------------------------------------------------------
// Legend
// ------------------------------------------------------------------

  // Spacing between legend
  space = height/cities.length

  // Add the main legend class
  var legend = svg.append("g")
    .attr("class", "legend") 
      
  // Add all the names with appropriate spacing  
  legend.selectAll('text')
    .data(cities)
    .enter()
    .append("text")
    .attr("id", function(d,i) {return d.name})
    .attr("x", width+ margin.left +10)
    .attr("y", function(d, i){ return (i+0.5) * space + margin.top;})
    .style("fill", function(d) {return color(d.name)})
    .text(function(d) { return d.name;})
    .on("click", function(d, i){
      // Set variable to active or inactive and denote the current stock index
      var active  = d.active ? false : true;
      d.active = active
      k = i
      if (active == true) {
        activeStock[k] = 1
      } else {activeStock[k] = 0}
      // Call functions that depent on activation of stock
      payoffResult()
      payoffLegendName()
      optionbars()
      editSlider()
      unCheckBoxes()
      if (checked_boxes[k] !== -1) {checkBoxes()}

      if (numtour == 3) {
        tour2()
      }
      // uncheck all boxes

      document.getElementById("strats").style.visibility = "visible"
      // Edit the information on thfe page
      document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)
      document.getElementById("stock").innerHTML = "Investing in " +cities[k].name;
      document.getElementById("stockPrice").innerHTML = "Current price  " +thisPrice[k];
      if (strUser == "shares") {
        document.getElementById("amount").value = thisAmount[k]
      }
      // When active
      if (active == true) {
        d3.select("#navbar")
          .transition().duration(1000)
          .style("background-color",color(d.name))
        // Values for the line, and change the line
        onOpacity = 5;
        offOpacity = 2;
        legend.select("#"+d.name)
              .transition().duration(1000)
              .style("font-size","15px")
              .style("font-weight","bold")
        d3.select("#"+d.name.replace(/\s+/g, ''))
            .transition().duration(1000) 
            .style("stroke-width", onOpacity)
            .style("opacity", 1);
        // Put all stocks except this one to false
        for (j = 0; j < cities.length; j++) {
          if (j != i) {
            d3.select("#"+cities[j].name)
              .transition().duration(1000) 
              .style("stroke-width", offOpacity)
              .style("opacity", 0.5);

            legend.select("#"+cities[j].name)
              .transition().duration(1000)
              .style("font-size","10px")
              .style("font-weight","normal")
              cities[j].active = false;
              activeStock[j] = 0
          };
        };
        // Change all the lines and to normal if none are active
      } else {
        d3.select("#navbar")
          .transition().duration(1000)
          .style("background-color","maroon")

        for (j = 0; j < cities.length; j++) {
          d3.select("#"+cities[j].name)
            .transition().duration(1000) 
            .style("stroke-width", 2)
            .style("opacity", 1);

          legend.select("#"+cities[j].name)
                .transition().duration(1000)
                .style("font-size","10px")
                .style("font-weight","normal")
        }
      }
    });
// ------------------------------------------------------------------
// Brush X Section
// ------------------------------------------------------------------
  
  // Place the x axis for the horizontal brush
  xBrush.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);  

  // Place all the stocks
  var city2 = xBrush.selectAll(".city2")
      .data(cities)
    .enter().append("g")
      .attr("class", "city2")

  city2.append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line2(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  xBrush.append("g")
      .attr("class", "x brush")
      .call(brushx)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height2 + 7);  

// ------------------------------------------------------------------
// Brush Y Section
// ------------------------------------------------------------------
  
  // Place the y axis for the vertical brush
  yBrush.append("g")
      .attr("class", "y axis")
      .call(yAxis4)
    .append("text")
      .attr("transform", "rotate(-90)")

  // Place all the stocks
  var city3 = yBrush.selectAll(".city3")
      .data(cities)
    .enter().append("g")
      .attr("class", "city3")

  city3.append("path")
      .attr("class", "line")
      .attr("d", function(d) {return line4(d.values); })
      .style("stroke", function(d) { return color(d.name); });

  // Call the brush element in a rectangle
  yBrush.append("g")
      .attr("class", "y brush")
      .call(brushy)
    .selectAll("rect")
      .attr("x", 0)
      .attr("width", width4)

// ------------------------------------------------------------------
// Tooltip Main Graph
// ------------------------------------------------------------------

  // Add a circle for the tooltip
  toolTip1.append("circle")                                 
      .attr("class", "y")                                
      .style("fill", "none")                             
      .style("stroke", "black")                           
      .attr("r", 4);

  // Add the text for the tooltip
  toolTip1.append("text")
      .attr("class", "y2")
      .attr("dx", -2)
      .attr("dy", -10)
      .style("font-size", "15px");

  // Rectangle for when the tooltip shows if the mouse is on it
  main.append("rect")                                     
      .attr("width", width)                              
      .attr("height", height+margin.bottom/3)                            
      .style("fill", "none")                             
      .style("pointer-events", "all")                    
      .on("mouseover", function() { toolTip1.style("display", null); })
      .on("mouseout", function() { toolTip1.style("display", "none"); })
      .on("mousemove", mousemove); 

  // Function for when the mouse moves on the rectangle
  function mousemove() {
    // Get the date, its index, values left and right of the date and the intrapolation
    var mouseDate = x.invert(d3.mouse(this)[0]),              
        i = bisectDate(cities[k].values, mouseDate, 1),                   
        d0 = cities[k].values[i - 1],                              
        d1 = cities[k].values[i],                            
        d = mouseDate - d0.date > d1.date - mouseDate ? d1 : d0;
    
    // Move the circle on the graph where the mouse is
    toolTip1.select("circle.y")                           
        .attr("transform",                             
              "translate(" + x(d.date) + "," +         
                             y(d.price) + ")");

    // Place the price above of the circle
    toolTip1.select("text.y2")
        .attr("transform",
              "translate(" + x(d.date) + "," +
                             y(d.price) + ")")
        .text(formatCurrency(d.price));   
    }

// ------------------------------------------------------------------
// Tooltip Payoff Graph
// ------------------------------------------------------------------

  toolTip2.append("circle")                                 
      .attr("class", "y")                                
      .style("fill", "none")                             
      .style("stroke", "black")                           
      .attr("r", 4);

  // Add the text for the tooltip
  toolTip2.append("text")
      .attr("class", "y2")
      .attr("dx", -2)
      .attr("dy", -30)
      .style("font-size", "15px");

  toolTip2.append("text")
      .attr("class", "y3")
      .attr("dx", -2)
      .attr("dy", -10)
      .style("font-size", "15px");

  // Rectangle for when the tooltip shows if the mouse is on it
  payoff.append("rect")                                     
      .attr("width", width3)                              
      .attr("height", height3)                            
      .style("fill", "none")                             
      .style("pointer-events", "all")                    
      .on("mouseover", function() { toolTip2.style("display", null); })
      .on("mouseout", function() { toolTip2.style("display", "none"); })
      .on("mousemove", mousemovepayoff); 

  // Function for when the mouse moves on the rectangle
  function mousemovepayoff() {
    // Get the date, its index, values left and right of the date and the intrapolation
    var mouseNum = x3.invert(d3.mouse(this)[0]);
    i2 = Math.round(mouseNum+30-thisPrice[k])
    if (payoffData[k].length !== 0) {
      if (payoffData[k].length === 1) {
        d = payoffData[k][payoffData[k].length-1][i2]}
      else { d = profit[i2]}
      toolTip2.select("circle.y")                           
          .attr("transform",                             
                "translate(" + x3(d.key) + "," +         
                               y3(d.price) + ")");

          +"\n" +"strke:"+formatCurrency(d.key)
      // Place the price above of the circle
      toolTip2.select("text.y2")
          .attr("transform",
                "translate(" + x3(d.key) + "," +
                               y3(d.price) + ")")
          .text("Profit: "+formatCurrency(d.price)); 

      toolTip2.select("text.y3")
          .attr("transform",
                "translate(" + x3(d.key) + "," +
                               y3(d.price) + ")")
          .text("Price: "+formatCurrency(Math.round(d.key)));
    } else {toolTip2.style("display", "none");}
  }

// ------------------------------------------------------------------
// Payoff graph
// ------------------------------------------------------------------ 

  // Initial empty graph
  x3.domain([0,0]);
  y3.domain([0,0]);
  payoffData = [[],[],[],[],[],[],[],[]]

  // Place the x axis
  payoff.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height3/2 + ")")
      .call(xAxis3)
      .append("text")
      .attr("y", 35)
      .attr("x", width3-30)
      .text("price ($)");

  // place the y axis
  payoff.append("g")
      .attr("class", "y axis")
      .call(yAxis3)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("profit ($)");
  

  // Graph after update (Not really that great atm) 
  window.payoffResult = function() {
    payoffData[k] = []
    // Remove all the old graphs
    payoff.selectAll(".city3").remove()

    //
    optionAmount = 0
    for (m=0; m<Object.keys(allData[k]).length; m++){
      optionAmount += Math.abs(allData[k][Object.keys(allData[k])[m]][0]);
      if (allData[k][Object.keys(allData[k])[m]][0] === "0") {
        delete allData[k][Object.keys(allData[k])[m]];
      }
    }
    // Create lines if there are line elements
    if (optionAmount !== 0) {
      // Compute all the line information
      for (i = 0; i < Object.keys(allData[k]).length; i++ ){
        lineInfo =[]
        for (j = thisPrice[k]-30; j <= thisPrice[k] +30; j++){
          // if it does contain c then its a call
          if (Object.keys(allData[k])[i].indexOf("c") !== -1 ){
            // replace the c
            thisStrike = Object.keys(allData[k])[i].replace("c","")
            lineInfo.push({
              key: j,
              price: allData[k][Object.keys(allData[k])[i]][0]
                      *(100 * d3.max([j - thisStrike,0]) 
                      - allData[k][Object.keys(allData[k])[i]][1])
            })
          // if it does contain p then its a put
          } else if (Object.keys(allData[k])[i].indexOf("p") !== -1) {
            thisStrike = Object.keys(allData[k])[i].replace("p","")
            lineInfo.push({
              key: j,
              price: allData[k][Object.keys(allData[k])[i]][0]
                      *(100 * d3.max([thisStrike - j,0]) 
                      - allData[k][Object.keys(allData[k])[i]][1])
            })
          // otherwise they are shares
          } else {
            lineInfo.push({
              key: j,
              price: (j-thisPrice[k]) * allData[k][Object.keys(allData[k])[i]][0]
            })             
          }
        }
        payoffData[k].push(lineInfo)
      }

      // No profit line if there is only 1 line
      profit = []
      for (j = 0; j < 61; j++) {
        profitKey = 0
        for (i = 0; i < payoffData[k].length; i++) {
          profitKey += payoffData[k][i][j].price
        }
        profit.push({
          key: payoffData[k][0][j].key,
          price: profitKey
        })
      }
      if (payoffData[k].length >=2) {payoffData[k].push(profit)}
    // Find the highest and lowest values
      yMax = 0;
      yMin = 0;
      dom = [];
      // Done by looping over all the elements and finding the highest and lowest
      for (i = 0; i<payoffData[k].length; i++) {
        for (j = 0; j < payoffData[k][i].length; j++) {
          if (payoffData[k][i][j].price < yMin) {yMin = payoffData[k][i][j].price}
          else if (payoffData[k][i][j].price > yMax) {yMax=payoffData[k][i][j].price}
        } 
      };
      dom = [yMin, yMax]

      // Set the domains
      x3.domain(d3.extent(payoffData[k][0], function(d) { return d.key; }));
      y3.domain(dom);

      // Set the intersection point to 1/2 of the graph if there are no lines
      if (payoffData[k].length == 0){
        intersection = 0.5
      } else{
        intersection =  Math.abs(dom[1])/(Math.abs(dom[1])+Math.abs(dom[0]));
      } 

      // Plot a max of 5 graphs
      if (payoffData[k].length > 5) {
        len = payoffData[k].length
        dataPlot = payoffData[k].slice(len-4, len)
      } else {
        dataPlot = payoffData[k]
      }

      // Plot all the lines
      var city3 = payoff.selectAll(".city3")
          .data(dataPlot)
        .enter().append("g")
          .attr("class", "city3");

      city3.append("path")
          .attr("id", function(d,i) {return cities[k].name;})
          .attr("d", function(d) { return line3(d); })
          .style("stroke", function(d,i) {
              if (i == dataPlot.length-1) {
                  return color(cities[k].name);
              } else {return "maroon";}    
          })
          .style("stroke-width", function(d,i) {
              if (i == dataPlot.length-1) {
                  return 3
              } else {return 1;}
          })
          .style("opacity", 0)
          .transition().duration(1500)
          .style("opacity", 1)
          .style("fill", "none")
          .style("stroke-dasharray", function(d,i){
              if (i == dataPlot.length-1) {
                  return 0,0;}
              else {return 5,5}
          })
    
    // Transition the x and y axis
      payoff.select(".x.axis").transition().duration(1000)
            .call(xAxis3)
            .attr("transform", "translate(0," + height3*intersection+ ")");
      payoff.select(".y.axis").transition().duration(1000).call(yAxis3);

    // Remove the profit line, gets recalculated anyway MAY GO AWAY
    } else {
      x3.domain([thisPrice[k]-30,thisPrice[k]+30]);
      y3.domain([0,0]);
      payoff.select(".x.axis").transition().duration(1000)
            .call(xAxis3)
            .attr("transform", "translate(0," + height3*0.5+ ")");
      payoff.select(".y.axis").transition().duration(1000).call(yAxis3);}

    payoff.select("#resultsLine").remove()
    payoff.select("#resultsText").remove()
    if (investButton === true) {
      if (GBM === true) {
        linePrice = GBMPrice
      } else {
        linePrice = lastPrice
      }
      payoff.append("line")
            .attr("id", "resultsLine")
            .attr("x1", x3(linePrice[k]))
            .attr("y1", 0)
            .attr("x2", x3(linePrice[k]))
            .attr("y2", height3)
            .attr("stroke-width", 2)
            .attr("stroke", "maroon")
            .attr("opacity" , 0)
            .transition().duration(1000)
            .attr("opacity" , 1);
      payoff.append("text")
            .attr("id", "resultsText")
            .attr("y", -10)
            .attr("x", x3(linePrice[k])-35)
            .attr("font-weight", "bold")
            .text("Price at 23rd Jan");
    }

  }

// ------------------------------------------------------------------
// Payoff Legend
// ------------------------------------------------------------------
  
  // Main element
  var payoffLegend = svg.append("g")
    .attr("class", "payoffLegend")
    
  // Name and color stock
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 450)
      .style("fill", color(cities[k].name))
      .text(cities[k].name)

  // Amount of stocks
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 470)
      .text(thisAmount[k] +" stocks")

  // Amount of options
  payoffLegend.append("text")
      .attr("x", width3 +marginPayoff.left +10)
      .attr("y", 490)
      .text(thisAmount[k] +" options")

  // Dynamically change the color and amounts
  window.payoffLegendName = function() {
    payoffLegend.select("text:nth-child(1)")
                .style("fill", color(cities[k].name))
                .text(cities[k].name)

    if (allData[k]["shares"] === undefined) {
      shareAmount = 0
    } else{
      shareAmount = allData[k]["shares"][0]
    }
    payoffLegend.select("text:nth-child(2)")
                .text(shareAmount +" stocks")
    num = 0
    for (i = 0;i < Object.keys(allData[k]).length; i++){
      if (Object.keys(allData[k])[i] != "shares"){
        num += Math.abs(allData[k][Object.keys(allData[k])[i]][0])
      }
    }
    num = parseInt(num)
    if (num == 1) {
      payoffLegend.select("text:nth-child(3)")
                  .text(num +" option")
    } else {
      payoffLegend.select("text:nth-child(3)")
                  .text(num +" options")
    }
  }

// ------------------------------------------------------------------
// Bar Chart
// ------------------------------------------------------------------ 

  window.optionbars = function(){
    // Every stock has a different amount of put/call options, so
    // we have to recalculate both the domains again.
    document.getElementById("optCounterPut").style.visibility = "hidden"
    document.getElementById("optCounterCall").style.visibility = "hidden"

    // Initialise variables
    strikesCall = [];
    pricesCall = [];
    strikesPut = [];
    pricesPut = [];
    // Append all the prices and strikes for the calls and the puts
    for (i=0; i<optionsJSON[cities[k].name].call.length; i++){
      strikesCall.push(optionsJSON[cities[k].name].call[i].strike)
      pricesCall.push(optionsJSON[cities[k].name].call[i].price*100)
    }
    for (i=0; i<optionsJSON[cities[k].name].put.length; i++){
      strikesPut.push(optionsJSON[cities[k].name].put[i].strike)
      pricesPut.push(optionsJSON[cities[k].name].put[i].price*100)
    }
    // Join the put and call prices in one array
    prices = pricesCall.concat(pricesPut);
    strikes = strikesCall.concat(strikesPut);

    // Find the domains of this data
    xbar.domain([0, d3.max(prices)]);
    ybar1.domain(strikesCall);
    ybar2.domain(strikesPut);

    // Remove old bars and axes
    chart1.selectAll(".bar").remove()
    chart2.selectAll(".bar2").remove()
    chart1.select(".y.axis").remove()
    chart2.select(".y.axis").remove()
    chart1.select(".x.axis").remove()
    chart2.select(".x.axis").remove()
    chart1.select("text").remove()
    chart2.select("text").remove()

    // Create the call bar charts
    chart1.selectAll(".bar")
        .data(optionsJSON[cities[k].name].call)
      .enter().append("rect")
        .attr("class", "bar")
        .attr("y", function(d) {return ybar1(d.strike); })
        .attr("height", ybar1.rangeBand())
        .attr("x", 1)
        .attr("width", function(d) {return xbar(d.price*100); })
        .on("click", function(d,i) {
          // Edit the visibility of the inputs and the text beside them
          document.getElementById("optCounterPut").style.visibility = "hidden"
          document.getElementById("optCounterCall").style.visibility = "visible"
          document.getElementById("optTypeCall").innerHTML = "Buy call option with strike $" 
                                  +d.strike +" for a price of $" +formatValue(d.price*100)
          // Amount of options is zero if the option is not in the dict
          if (allData[k][d.strike+"c"] === undefined) {
              document.getElementById("numCall").value = 0
          // Amount of options is equal to the first element of the array in the dict
           } else {
            document.getElementById("numCall").value = allData[k][d.strike+"c"][0]
           }
           // Set this option info to the variable 
          optionInfo = d
        })
        .style("opacity", 0)
        .transition().duration(1000)
        .style("opacity", 1);

    // Create the put bar charts with
    chart2.selectAll(".bar2")
        .data(optionsJSON[cities[k].name].put)
      .enter().append("rect")
        .attr("class", "bar2")
        .attr("y", function(d) {return ybar2(d.strike); })
        .attr("height", ybar2.rangeBand())
        .attr("x", 1)
        .attr("width", function(d) {return xbar(d.price*100); })
        .on("click", function(d,i) {
         // Edit the visibility of the inputs and the text beside them
         document.getElementById("optCounterCall").style.visibility = "hidden"
         document.getElementById("optCounterPut").style.visibility = "visible"
         document.getElementById("optTypePut").innerHTML = "Buy put option with strike $" +d.strike +" for a price of $" +formatValue(d.price*100)
         // Amount of options is zero if the option is not in the dict
         if (allData[k][d.strike+"p"] === undefined) {
          document.getElementById("numPut").value = 0
          // Amount of options is equal to the first element of the array in the dict
         } else {
          document.getElementById("numPut").value = allData[k][d.strike+"p"][0]
         }
         // Set this option info to the variable
         optionInfo = d
        })
        .style("opacity", 0)
        .transition().duration(1000)
        .style("opacity", 1);

      // y axis call options
      chart1.append("g")
            .attr("class", "y axis")
            .call(yAxisbar1)
            .style("opacity", 0)
            .transition().duration(1000)
            .style("opacity", 1);

      chart1.append("text")
          .attr("x", -30)
          .attr("y", -15)
          .attr("dy", ".71em")
          .text("Strike price of Call options")
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

    // y axis put options
    chart2.append("g")
          .attr("class", "y axis")
          .call(yAxisbar2)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

    chart2.append("text")
          .attr("x", -30)
          .attr("y", -15)
          .attr("dy", ".71em")
          .text("Strike price of Put options")
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

    // x axis call options
    chart1.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + heightbar + ")")
          .call(xAxisbar)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);

    // x axis put options
    chart2.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + heightbar + ")")
          .call(xAxisbar)
          .style("opacity", 0)
          .transition().duration(1000)
          .style("opacity", 1);
  }

// ------------------------------------------------------------------
// END OF D3.JSON(){}
// ------------------------------------------------------------------
});
  // Remove old slider and append a new slider with the 
  // amount of shares are invested
  function editSlider(){
    d3.select("#slider").remove()
    d3.select("body").append("input")
    .attr("id", "slider")
    .attr("type", "range")
    .attr("min", -5)
    .attr("max", 5)
    .attr("value", thisAmount[k]/5)
    .style("visibility", "visible")
    .text("works?")
    .on("change", function() {
      allData[k]["shares"] = [this.value*5, ""]
      payoffLegendName()
      payoffResult()
      moneyLeft()
      if (allData[k]["shares"] !== undefined) {
        document.getElementById("shareSlider").innerHTML =  this.value*5 +" shares"
      }
    });
  }

// ------------------------------------------------------------------
// Brush function
// ------------------------------------------------------------------

  // Horizontal brush
  function brushedx() {
    // Set the main x domain to the brushed domain
    x.domain(brushx.empty() ? x2.domain() : brushx.extent());
    // Transition back to normal if the brush is empty
    if (brushx.empty()) {
      main.select(".x.axis")
          .transition().duration(1000)
          .call(xAxis);
      for (i = 0; i<cities.length; i++) {
        main.select("#"+cities[i].name)
            .transition().duration(1000)
            .attr("d", function(d){return line1(d.values)});
      };
    //Edit the main graph to the extent of the brush
    } else {
        main.select(".x.axis").call(xAxis);
        for (i = 0; i<cities.length; i++) {
          main.select("#"+cities[i].name)
              .attr("d", function(d){return line1(d.values)});
        };
    }
  }

  // Vertical brush
  function brushedy() {
    // Set the main y domain to the brushed domain
    y.domain(brushy.empty() ? y4.domain() : brushy.extent());
    // Transition back to normal if the brush is empty
    if (brushy.empty()) {
      main.select(".y.axis")
          .transition().duration(1000)
          .call(yAxis);
      for (i = 0; i<cities.length; i++) {
        main.select("#"+cities[i].name)
            .transition().duration(1000)
            .attr("d", function(d){return line1(d.values)});
      };
    // Edit the main graph to the extent of the brush
    } else {
      main.select(".y.axis").call(yAxis);
      for (i = 0; i<cities.length; i++) {
        main.select("#"+cities[i].name).attr("d", function(d){return line1(d.values)});
      };
    }
  }

// ------------------------------------------------------------------
// Strats NOT FUNCTIONAL YET!!!!!
// ------------------------------------------------------------------
    
    function bullSpread() {
      clearInput()
      investButton = false
      checked_boxes[k] = 0
      allData[k] = {}
        difference = 10000
        for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
          thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
          if (thisDifference < difference) {
            difference = thisDifference
            longStrike = optionsJSON[cities[k].name].call[i].strike
            longPrice = optionsJSON[cities[k].name].call[i].price
          }
          if (i == optionsJSON[cities[k].name].call.length-1) {
            shortStrike = optionsJSON[cities[k].name].call[i].strike
            shortPrice = optionsJSON[cities[k].name].call[i].price
            allData[k][shortStrike+"c"] = [-1, shortPrice*100]
          }

        }
      allData[k][longStrike+"c"] = [1, longPrice*100]
      editSlider()
      payoffLegendName()
      payoffResult()
      moneyLeft()
    }

    function bearSpread() {
      clearInput()
      investButton = false
      checked_boxes[k] = 1
      allData[k] = {}
      difference = 10000
      for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
        if (thisDifference < difference) {
          difference = thisDifference
          longStrike = optionsJSON[cities[k].name].call[i].strike
          longPrice = optionsJSON[cities[k].name].call[i].price
        }
        if (i == 0) {
          shortStrike = optionsJSON[cities[k].name].call[i].strike
          shortPrice = optionsJSON[cities[k].name].call[i].price
          allData[k][shortStrike+"c"] = [-1, shortPrice*100]
        }
      }
      allData[k][longStrike+"c"] = [1, longPrice*100]
      editSlider()
      payoffLegendName()
      payoffResult()
      moneyLeft()
    }

    function backSpread() {
      clearInput()
      investButton = false
      checked_boxes[k] = 2
      allData[k] = {}
      difference = 10000
      for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
        if (thisDifference < difference) {
          difference = thisDifference
          shortIndex = i
        }
      }
      if (k == 0) {shortIndex += 1}

      shortStrike = optionsJSON[cities[k].name].call[shortIndex-1].strike
      shortPrice = optionsJSON[cities[k].name].call[shortIndex-1].price
      longPrice1 = optionsJSON[cities[k].name].call[shortIndex+1].price
      longStrike1 = optionsJSON[cities[k].name].call[shortIndex+1].strike

      allData[k][shortStrike+"c"] = [-1, shortPrice*100]
      allData[k][longStrike1+"c"] = [2, longPrice1*100]
      editSlider()
      payoffLegendName()
      payoffResult()
      moneyLeft()
    }

    function strangleSpread() {
      clearInput()
      investButton = false
      checked_boxes[k] = 4
      allData[k] = {}
      differenceCall = 10000
      for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
        if (thisDifference < differenceCall) {
          differenceCall = thisDifference
          longStrikeCall = optionsJSON[cities[k].name].call[i].strike
          longPriceCall = optionsJSON[cities[k].name].call[i].price
        }
      }
      differencePut = 10000
      for (i = 0; i < optionsJSON[cities[k].name].put.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].put[i].strike)
        if (thisDifference < differencePut) {
          differencePut = thisDifference
          longStrikePut = optionsJSON[cities[k].name].put[i].strike
          longPricePut = optionsJSON[cities[k].name].put[i].price
        }
      }
      allData[k][longStrikeCall+"c"] = [1, longPriceCall*100]
      allData[k][longStrikePut+"p"] = [1, longPricePut*100]
      editSlider()
      payoffLegendName()
      payoffResult()
      moneyLeft()
    }

    function ironSpread() {
      clearInput()
      investButton = false
      checked_boxes[k] = 3
      allData[k] = {}
      differenceCall = 10000
      for (i = 0; i < optionsJSON[cities[k].name].call.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].call[i].strike)
        if (thisDifference < differenceCall) {
          differenceCall = thisDifference
          callButterflyIndex = i
        }
      }

      differencePut = 10000
      for (i = 0; i < optionsJSON[cities[k].name].put.length; i++){
        thisDifference = Math.abs(thisPrice[k] - optionsJSON[cities[k].name].put[i].strike)
        if (thisDifference < differencePut) {
          differencePut = thisDifference
          putButterflyIndex = i
        }
      }
      if (k == 3) {
        callButterflyIndex -=1
        putButterflyIndex -=1
      }
      callPrice1 = optionsJSON[cities[k].name].call[callButterflyIndex].price
      callStrike1 = optionsJSON[cities[k].name].call[callButterflyIndex].strike
      callPrice2 = optionsJSON[cities[k].name].call[callButterflyIndex+2].price
      callStrike2 = optionsJSON[cities[k].name].call[callButterflyIndex+2].strike

      putPrice1 = optionsJSON[cities[k].name].put[putButterflyIndex].price
      putStrike1 = optionsJSON[cities[k].name].put[putButterflyIndex].strike
      putPrice2 = optionsJSON[cities[k].name].put[putButterflyIndex-2].price
      putStrike2 = optionsJSON[cities[k].name].put[putButterflyIndex-2].strike

      allData[k][callStrike1+"c"] = [-1, callPrice1*100]
      allData[k][callStrike2+"c"] = [1, callPrice2*100]
      allData[k][putStrike1+"p"] = [-1, putPrice1*100]
      allData[k][putStrike2+"p"] = [1, putPrice2*100]
      editSlider()
      payoffLegendName()
      payoffResult()
      moneyLeft()
    }

// ------------------------------------------------------------------
// Money left
// ------------------------------------------------------------------
  
  function moneyLeft() {
    totalInvestment = 10000
    // for each stock
    for (i = 0; i < allData.length; i++) {
    // for each element in the stock
      for (j = 0; j < Object.keys(allData[i]).length; j++) {
        if (Object.keys(allData[i])[j] == "shares") {
          totalInvestment -= allData[i][Object.keys(allData[i])[j]][0]*thisPrice[i]
        } else {
          totalInvestment -=allData[i][Object.keys(allData[i])[j]][0]*
                            allData[i][Object.keys(allData[i])[j]][1]
        }
      }
    }
    // Set the amout of money left on the HTML page
    document.getElementById("money").innerHTML = "Money left: $" + formatValue(totalInvestment)
  }

// ------------------------------------------------------------------
// Investment results
// ------------------------------------------------------------------

  // Results 
  function results() {
    // find the key of profit list
    prof = 0
    resultTest = ""
    for (i = 0; i < cities.length; i++) {
      stockName = cities[i].name
      if (payoffData[i].length !== 0) {
        if (GBM === true) {
          finalKey = Math.round(GBMPrice[i] - thisPrice[i]+30)
        } else {
          finalKey = Math.round(lastPrice[i] - thisPrice[i]+30)
        }
        stockResult = payoffData[i][payoffData[i].length-1][finalKey].price
        prof += stockResult
        resultTest += stockName +": " +formatCurrency(stockResult) + "\n"
      } else {
        resultTest += stockName +": $ 0.00 \n"
      }
    }
    if (prof >= 0) {
      resultTest += "You made a PROFIT of " +formatCurrency(prof)
      alert(resultTest)
    } else {
      prof = -prof
      resultTest += "You made a LOSS of " +formatCurrency(prof)
      alert(resultTest)
    }
    investButton = true
    payoffResult()
    GBM = false
  }

  function GBMresults() {
    GBMPrice = []
    sigma = 0.5*Math.random()
    mu = 0.5*Math.random()
    for (l = 0; l<cities.length; l++) {
      So = thisPrice[l]
      dt = (14/252)/1000
      for (i=0; i<1000; i++) {
        So *= Math.exp((mu - 0.5*sigma*sigma)*dt + sigma*eps()*Math.sqrt(dt))
      }
      So = d3.max([So,thisPrice[l]-30])
      So = d3.min([So,thisPrice[l]+30])
      GBMPrice.push(So)
    }
    GBM = true
    results()
  }

  function optGraphPut() {
    // Set the amount of put options of specific strike in the data list
    amountOpts = document.getElementById("numPut").value
    allData[k][optionInfo.strike+"p"] = [amountOpts, optionInfo.price*100]
    payoffResult()
    payoffLegendName()
    moneyLeft()
  }

  function optGraphCall() {
    // Set the amount of call options of specific strike in the data list
    amountOpts = document.getElementById("numCall").value
    allData[k][optionInfo.strike+"c"] = [amountOpts, optionInfo.price*100]
    payoffResult()
    payoffLegendName()
    moneyLeft()
  }

  function clearAll() {
    clearInput()
    allData = [{},{},{},{},{},{},{},{}]
    checked_boxes = [-1,-1,-1,-1,-1,-1,-1,-1]
    unCheckBoxes()
    editSlider()
    payoffResult()
    payoffLegendName()
    moneyLeft()
    investButton = false
  }

  function clearStock() {
    clearInput()
    allData[k] = {}
    unCheckBoxes()
    editSlider()
    payoffResult()
    payoffLegendName()
    moneyLeft()
  }

  function clearInput() {
    document.getElementById("numPut").value = 0
    document.getElementById("numCall").value = 0
  }

// ------------------------------------------------------------------
// Tour of visualisation
// ------------------------------------------------------------------  

  function tour() {
    if (numAbout !== 0) {
      document.getElementById("about_"+(numAbout-1)).style.visibility = "hidden"
    }
    if (numInfo !== 0 ) {
      document.getElementById("info_"+(numInfo-1)).style.visibility = "hidden"
    }
    remember = allData[k]
    allData[k] = {}
    d3.select("svg").style("opacity", 0.6)
    numtour = 0
    // If somebody presses the tour when there is already a tour in progress
    for (i=0; i<10; i++){
      document.getElementById("help_"+i).style.visibility = "hidden"
    }
    tour2()
  }

  function tour2() {
    if (numtour == 10) {
      tour3()
    } else {
      if (numtour != 0) {
        document.getElementById("help_"+(numtour-1)).style.visibility = "hidden"
      }

      if (numtour == 3) {
        tourStockName = cities[k].name
        if (tourStockName === "RalphLauren") {
          tourStockName = "Ralph Lauren"
        } else if (tourStockName === "MasterCard") {
          tourStockName = "Master Card"
        }
        document.getElementById("tourName").innerHTML = tourStockName
        tester = 0
        for (i = 0; i < activeStock.length; i++){
          tester += activeStock[i]
        }
        if (tester == 0 ){
          numtour -= 1
        }
      }
      document.getElementById("help_"+numtour).style.visibility = "visible"

      if (numtour == 7) {
        thisAmount[k] = 4
        editSlider()
        allData[k]["shares"] = [thisAmount[k]*5, ""]
        payoffResult()
        payoffLegendName()
        moneyLeft()
      }
      if (numtour == 8) {
        document.getElementById("bull").checked = true
        bullSpread()
        payoffLegendName()
      }
      if (numtour == 9) {
        document.getElementById("bull").checked = false
        document.getElementById("optCounterCall").style.visibility = "visible"
        allData[k] = {}
        tourStrike = optionsJSON[cities[k].name].call[0].strike
        tourPrice = optionsJSON[cities[k].name].call[0].price
        allData[k][tourStrike +"c"] = [2, tourPrice*100]
        payoffResult()
        payoffLegendName()
      }

      numtour += 1
      }
  }
  
  function tour3(){
      d3.select("svg").style("opacity", 1)
      allData[k] = remember
      document.getElementById("help_"+(numtour-1)).style.visibility = "hidden"
      document.getElementById("optCounterCall").style.visibility = "hidden"
      payoffResult()
      payoffLegendName()
      editSlider()
  }

  function about() {
    if (numtour !== 0) {
      document.getElementById("help_"+(numtour-1)).style.visibility = "hidden"
    }
    if (numInfo !==0 ) {
      document.getElementById("info_"+(numInfo-1)).style.visibility = "hidden"
    }
    d3.select("svg").style("opacity", 0.6)
    numAbout = 1
    about2()
  }

  function about2() {
    if (numAbout === 4) {
      about3()
    } else {
      if (numAbout != 1) {
        document.getElementById("about_"+(numAbout-1)).style.visibility = "hidden"
      }
      document.getElementById("about_"+numAbout).style.visibility = "visible"
      numAbout += 1
      }
  }

  function about3() {
    document.getElementById("about_"+(numAbout-1)).style.visibility = "hidden"
    d3.select("svg").style("opacity", 1)
  }

  function info() {
    document.getElementById("strats").style.visibility = "visible"
    if (numtour !== 0) {
      document.getElementById("help_"+(numtour-1)).style.visibility = "hidden"
    }
    if (numAbout !== 0) {
      document.getElementById("about_"+(numAbout-1)).style.visibility = "hidden"
    }
    d3.select("svg").style("opacity", 0.6)
    numInfo = 1
    info2()
  }

  function info2() {
    if (numInfo === 7) {
      info3()
    } else {
      if (numInfo != 1) {
        document.getElementById("info_"+(numInfo-1)).style.visibility = "hidden"
      }
      document.getElementById("info_"+numInfo).style.visibility = "visible"
      numInfo += 1
      }
  }

  function info3() {
    document.getElementById("info_"+(numInfo-1)).style.visibility = "hidden"
    d3.select("svg").style("opacity", 1)
  }

  function unCheckBoxes() {
    boxes = document.getElementsByName("strategy")
    for (l=0; l<boxes.length; l++){
        boxes[l].checked = false
    }

  window.checkBoxes = function() {
    boxes = document.getElementsByName("strategy")
    boxes[checked_boxes[k]].checked = true
  }

// ------------------------------------------------------------------
// END OF JAVASCRIOT
// ------------------------------------------------------------------
}
</script>
<div id="about_1" class="box">
<p>Hello and welcome to my visualisation! Many first time investors hear stories about people who gain large amounts of money by investing in the stock market. Usually these people invest in options and not in shares. But without a good view of what options really are, they can be a very dangerous investment. As a result, many people who randomly invest in options lose their entire investment. <br> For this visualisation you will be able to invest in options or shares. Click the next button to read about what shares and options really are, visit the tour to find out how my visualisation works, visit the option info to find information about the strategies that are available or visit the terms tab for often used abbreviations.</p>
<a onclick="about2()" class="nextBut"/>Next</a> <span><a onclick="about3()" class="exitBut"/>X</a></span>
</div>

<div id="about_2" class="box">
<p>A share is a unit of ownership in a corporation or financial asset. Thus, if you own a share of Apple, you "own" part Apple. Although you don't have direct control over buisiness operations, you are entitled to an equal distribution of the profits, in the form of dividend. Many people who invest in shares seek to obtain profit in two possible ways:<br> 1. Price differences of the shares between buying and selling them <br> 2. Profits obtained from dividends. <br> In this visualisation profit can be obtained from the first way. Your profit will be shown as <b># Stocks * (ST - S0)</b> where <b>ST</b> is the stock price at time of selling and <b>S0</b> that of buying. <br> The next section will explain options. </p>
<a onclick="about2()" class="nextBut"/>Next</a> <span><a onclick="about3()" class="exitBut"/>X</a></span>
</div>

<div id="about_3" class="box">
<p>As mentioned previously, options can be a dangerous investment. In this visualisation I look into two different options: Call and Put options. A call (put) option gives the holder the right, but not the obligation, to enter into a contract to buy (sell) 100 shares for a predetermined price, called the strike price (K), and date, called the expiration date. <br> What makes this way of investing dangerous, is that if the price at expiration date of a call (put) is lower (higher) than the strike price, the buyer loses all his investment! Your profit will be shown as <b>100 * max(ST-K,0) - price</b> for calls and <b>100 * max(K-ST,0) - price</b> for puts.</p>
<a onclick="about2()" class="nextBut"/>Next</a> <span><a onclick="about3()" class="exitBut"/>X</a></span>
</div>

  <div id="help_0" class="bubble1">
    <p>Hello, and welcome to the tour of my visualisation.<br> I advise all of you to first look at the "about" button before going through the tour! If you have, or dont feel like it, then press the "next" button!</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_1" class="bubble">
    <p>The first main thing we notice is the stock graph. Here we can see stock quotes from previous dates and may help you in choosing you investment type and amount. </p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_2" class="bubble2">
    <p>The legend is the drive of this visualisation. By clicking on one of the legend names the line for this stock will light up, and you can invest in this stock. Give it a try if you haven't yet!</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_3" class="bubble">
    <p>You chose <span id="tourName"></span>, great choice!<br> Past dates may distort your preferred viewing, try zooming in by clicking and dragging either this horizontal or vertical section</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

    <div id="help_4" class="bubble2">
    <p>For reference, here we find the selected stock, our remaining investment, the current price of the selected stock and finally a button for when you want to finalize your investment.</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_5" class="bubble">
    <p>Here we see the payoff graph. After investing in either shares or options of a specific stock, the dotted lines will show their profit. More importantly, the solid line will show their combined profit. Hover over the section to observe the total profit! We will see this payoff graph in action in the comming steps. <br>Note: Only 5 lines will be shown!</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_6" class="bubble">
    <p>Finally the totallity of this section below shows if we want to remove our investments and all the possible ways we can invest in a stock. After each of the current "next" clicks our payoff graph will change with respect to what we invest in, pay attention! As mentioned previously, hover over the payoff graph to observe your profit coupled with possible future stock price.</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_7" class="bubble">
    <p>The first thing we can invest in are simple shares. Where we can see some random linear payoff depending on the difference between the current and past stock price.</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_8" class="bubble">
    <p>The second posibility is investing in option strategies. These are highly used strategies within investment trading. If you want information regarding all the strategies, click on the "help" button after the tour</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="help_9" class="bubble">
    <p>We finally have the option to invest in some single options to your liking. But pay attention to your money, because it can drop rapidly (shorting shares will decrease the price of the option by 10%)</p>
    <a onclick="tour2()" class="nextBut"/>Next</a> <span><a onclick="tour3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_1" class="bubble">
    <p>Spreads are very important when investing in options. Investing in only a put or call option can result in losing your entire investment. Spreads are a way to both hedge your losses when the market does something unexpected or gives you a way to obtain payoffs which can only be obtained when combining options. In the following steps all the spreads below will be explained. <br> Note: Unknown terms used in the comming sections can be found in "terms" box above.</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_2" class="bubble">
    <p>The first is the bull spread. This spread is used when the investor expects the stock price to rise, but still wants to limit his loss after a possible decline in price. For example, assume Apple releases a brand new phone. You, as an investor, expect this new phone to be very popular and thus expect Apples stock price to rise. But you know there is also a small probability that the phone will not get a fantastic reception, and thus want to limit the loss after this occurance. <br> This spread is obtained by buying one ATM call option, and writing one OTM call option</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_3" class="bubble">
    <p>The second is the bear spread. In general, the bear spread is used when the investor expects the stock to behave in the opposite way as the bull spread. Thus assuming Apple releases a new phone, you expect this phone to have a very poor reception, but know there is a chance that it will be popular. <br> This spread is obtained by buying one ATM call option, and writing one ITM call option.</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_4" class="bubble">
    <p>The third, the back spread, is a somewhat odd looking spread. This spread is used when you know for sure that the stock price is going to change, and expect it to rise, but that the chance of it dropping is larger than, for example in the bull spread. As an example we can turn to Apple again. The release of the iWatch was not well known, and you expect it to have a great reception. But due to the fact that it is the first ever release, it could also be a bust. In both scenarios you will gain profit. <br> This spread is obtained by writing one ATM call option, and buying two OTM call options</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_5" class="bubble">
    <p>The iron butterfly spread is the third spread. In this spread you expect the stock price to stay put, but limit your losses when it does move. An example would be a large period in time where neither Apple nor his impetitors do not expect to make any ground breaking annoucements. <br> This spread is obtained by writing an ATM call and put option, and buying an OTM call and put option.</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="info_6" class="bubble">
    <p>Finally, the last spread I consider is the strangle spread. In this spread you expect expect the stock price to either rise or drop, but give equal probability to both occurances. An example would be when both Apple and one of its competitors releases a new item, but do not know the ins and outs of either of them. <br> This spread is obtained by buying one ATM call option and writing one ATM put option.</p>
    <a onclick="info2()" class="nextBut"/>Next</a> <span><a onclick="info3()" class="exitBut"/>X</a></span>
  </div>

  <div id="terms" class="box">
  <p>S0 : Price at buying <br>
  ST : Price at selling <br>
  K  : Price to buy or sell stocks at in a future date (strike price) <br>
  ATM: option where K ~ S0 (At the money) <br>
  ITM: option where K &lt; S0 if call; K &gt; S0 if put (in the money) <br>
  OTM: option where K &gt; S0 if call; K &lt; S0 if put (out the money)</p>
  <a onclick="document.getElementById('terms').style.visibility = 'hidden'" class="exitBut"/>X</a>
</div>

<div id="verticalline"></div>
<div id="horizontalline1"></div>
<div id="horizontalline2"></div>
<div id="shareSlider"></div>

<form id="strats">
<input id="bull" type="radio" name="strategy" value="Bull" onchange="bullSpread()">Bull Spread<br>
<input id="bear" type="radio" name="strategy" value="Bear" onchange="bearSpread()">Bear Spread<br>
<input id="back" type="radio" name="strategy" value="Back" onchange="backSpread()">Back Spread<br>
<input id="ironButterfly" type="radio" name="strategy" value="ironButterfly" onchange="ironSpread()">Iron Butterfly Spread<br>
<input id="straddle" type="radio" name="strategy" value="Bear" onchange="strangleSpread()">Straddle Spread<br>
</form>
<div id="spreadInfo"></div>
<button type="button" id="stockClear" onclick="clearStock()">Clear current</div>
<button type="button" id="investClear" onclick="clearAll()">Clear all</div>